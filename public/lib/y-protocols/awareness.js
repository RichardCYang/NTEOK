/* esm.sh - y-protocols@1.0.7/awareness */
var x=Math.floor;var j=(t,e)=>t<e?t:e,P=(t,e)=>t>e?t:e,_t=Number.isNaN;var z=Number.MAX_SAFE_INTEGER,kt=Number.MIN_SAFE_INTEGER,Et=1<<31;var Nt=Number.isInteger||(t=>typeof t=="number"&&isFinite(t)&&x(t)===t),vt=Number.isNaN,Vt=Number.parseInt;var R=()=>new Set;var G=Array.from;var et=String.fromCharCode,Lt=String.fromCodePoint,Ct=et(65535);var st=t=>{let e=unescape(encodeURIComponent(t)),s=e.length,r=new Uint8Array(s);for(let o=0;o<s;o++)r[o]=e.codePointAt(o);return r},m=typeof TextEncoder<"u"?new TextEncoder:null,rt=t=>m.encode(t),H=m?rt:st;var g=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});g&&g.decode(new Uint8Array).length===1&&(g=null);var B=class{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}},k=()=>new B;var nt=t=>{let e=t.cpos;for(let s=0;s<t.bufs.length;s++)e+=t.bufs[s].length;return e};var E=t=>{let e=new Uint8Array(nt(t)),s=0;for(let r=0;r<t.bufs.length;r++){let o=t.bufs[r];e.set(o,s),s+=o.length}return e.set(new Uint8Array(t.cbuf.buffer,0,t.cpos),s),e};var d=(t,e)=>{let s=t.cbuf.length;t.cpos===s&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(s*2),t.cpos=0),t.cbuf[t.cpos++]=e};var p=(t,e)=>{for(;e>127;)d(t,128|127&e),e=x(e/128);d(t,127&e)};var _=new Uint8Array(3e4),it=_.length/3,ct=(t,e)=>{if(e.length<it){let s=m.encodeInto(e,_).written||0;p(t,s);for(let r=0;r<s;r++)d(t,_[r])}else pt(t,H(e))},at=(t,e)=>{let s=unescape(encodeURIComponent(e)),r=s.length;p(t,r);for(let o=0;o<r;o++)d(t,s.codePointAt(o))},N=m&&m.encodeInto?ct:at;var lt=(t,e)=>{let s=t.cbuf.length,r=t.cpos,o=j(s-r,e.length),n=e.length-o;t.cbuf.set(e.subarray(0,o),r),t.cpos+=o,n>0&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(P(s*2,n)),t.cbuf.set(e.subarray(o)),t.cpos=n)},pt=(t,e)=>{p(t,e.byteLength),lt(t,e)};var Ft=new DataView(new ArrayBuffer(4));var v=t=>new Error(t);var ht=v("Unexpected end of array"),xt=v("Integer out of Range"),V=class{constructor(e){this.arr=e,this.pos=0}},L=t=>new V(t);var gt=(t,e)=>{let s=new Uint8Array(t.arr.buffer,t.pos+t.arr.byteOffset,e);return t.pos+=e,s},mt=t=>gt(t,f(t));var Z=t=>t.arr[t.pos++];var f=t=>{let e=0,s=1,r=t.arr.length;for(;t.pos<r;){let o=t.arr[t.pos++];if(e=e+(o&127)*s,s*=128,o<128)return e;if(e>z)throw xt}throw ht};var yt=t=>{let e=f(t);if(e===0)return"";{let s=String.fromCodePoint(Z(t));if(--e<100)for(;e--;)s+=String.fromCodePoint(Z(t));else for(;e>0;){let r=e<1e4?e:1e4,o=t.arr.subarray(t.pos,t.pos+r);t.pos+=r,s+=String.fromCodePoint.apply(null,o),e-=r}return decodeURIComponent(escape(s))}},bt=t=>g.decode(mt(t)),C=g?bt:yt;var b=Date.now;var S=()=>new Map;var J=(t,e,s)=>{let r=t.get(e);return r===void 0&&t.set(e,r=s()),r};var T=class{constructor(){this._observers=S()}on(e,s){J(this._observers,e,R).add(s)}once(e,s){let r=(...o)=>{this.off(e,r),s(...o)};this.on(e,r)}off(e,s){let r=this._observers.get(e);r!==void 0&&(r.delete(s),r.size===0&&this._observers.delete(e))}emit(e,s){return G((this._observers.get(e)||S()).values()).forEach(r=>r(...s))}destroy(){this._observers=S()}};var M=Symbol("Equality");var Tt=Object.keys;var q=t=>Tt(t).length;var $=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var y=(t,e)=>{if(t===e)return!0;if(t==null||e==null||t.constructor!==e.constructor&&(t.constructor||Object)!==(e.constructor||Object))return!1;if(t[M]!=null)return t[M](e);switch(t.constructor){case ArrayBuffer:t=new Uint8Array(t),e=new Uint8Array(e);case Uint8Array:{if(t.byteLength!==e.byteLength)return!1;for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!1;break}case Set:{if(t.size!==e.size)return!1;for(let s of t)if(!e.has(s))return!1;break}case Map:{if(t.size!==e.size)return!1;for(let s of t.keys())if(!e.has(s)||!y(t.get(s),e.get(s)))return!1;break}case void 0:case Object:if(q(t)!==q(e))return!1;for(let s in t)if(!$(t,s)||!y(t[s],e[s]))return!1;break;case Array:if(t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(!y(t[s],e[s]))return!1;break;default:return!1}return!0};import "yjs";var F=3e4,W=class extends T{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{let s=b();this.getLocalState()!==null&&F/2<=s-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());let r=[];this.meta.forEach((o,n)=>{n!==this.clientID&&F<=s-o.lastUpdated&&this.states.has(n)&&r.push(n)}),r.length>0&&Bt(this,r,"timeout")},x(F/10)),e.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){let s=this.clientID,r=this.meta.get(s),o=r===void 0?0:r.clock+1,n=this.states.get(s);e===null?this.states.delete(s):this.states.set(s,e),this.meta.set(s,{clock:o,lastUpdated:b()});let i=[],l=[],c=[],u=[];e===null?u.push(s):n==null?e!=null&&i.push(s):(l.push(s),y(n,e)||c.push(s)),(i.length>0||c.length>0||u.length>0)&&this.emit("change",[{added:i,updated:c,removed:u},"local"]),this.emit("update",[{added:i,updated:l,removed:u},"local"])}setLocalStateField(e,s){let r=this.getLocalState();r!==null&&this.setLocalState({...r,[e]:s})}getStates(){return this.states}},Bt=(t,e,s)=>{let r=[];for(let o=0;o<e.length;o++){let n=e[o];if(t.states.has(n)){if(t.states.delete(n),n===t.clientID){let i=t.meta.get(n);t.meta.set(n,{clock:i.clock+1,lastUpdated:b()})}r.push(n)}}r.length>0&&(t.emit("change",[{added:[],updated:[],removed:r},s]),t.emit("update",[{added:[],updated:[],removed:r},s]))},Rt=(t,e,s=t.states)=>{let r=e.length,o=k();p(o,r);for(let n=0;n<r;n++){let i=e[n],l=s.get(i)||null,c=t.meta.get(i).clock;p(o,i),p(o,c),N(o,JSON.stringify(l))}return E(o)},Gt=(t,e)=>{let s=L(t),r=k(),o=f(s);p(r,o);for(let n=0;n<o;n++){let i=f(s),l=f(s),c=JSON.parse(C(s)),u=e(c);p(r,i),p(r,l),N(r,JSON.stringify(u))}return E(r)},Ht=(t,e,s)=>{let r=L(e),o=b(),n=[],i=[],l=[],c=[],u=f(r);for(let D=0;D<u;D++){let a=f(r),U=f(r),h=JSON.parse(C(r)),w=t.meta.get(a),Y=t.states.get(a),O=w===void 0?0:w.clock;(O<U||O===U&&h===null&&t.states.has(a))&&(h===null?a===t.clientID&&t.getLocalState()!=null?U++:t.states.delete(a):t.states.set(a,h),t.meta.set(a,{clock:U,lastUpdated:o}),w===void 0&&h!==null?n.push(a):w!==void 0&&h===null?c.push(a):h!==null&&(y(h,Y)||l.push(a),i.push(a)))}(n.length>0||l.length>0||c.length>0)&&t.emit("change",[{added:n,updated:l,removed:c},s]),(n.length>0||i.length>0||c.length>0)&&t.emit("update",[{added:n,updated:i,removed:c},s])};export{W as Awareness,Ht as applyAwarenessUpdate,Rt as encodeAwarenessUpdate,Gt as modifyAwarenessUpdate,F as outdatedTimeout,Bt as removeAwarenessStates};
//# sourceMappingURL=awareness.bundle.mjs.map