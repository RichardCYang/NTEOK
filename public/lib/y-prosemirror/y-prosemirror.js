/* esm.sh - y-prosemirror@1.2.1 */

import*as E from "yjs";import{Decoration as Jt,DecorationSet as Kt}from "prosemirror-view";import{Plugin as un}from "prosemirror-state";import "y-protocols";var ct=()=>{let e=!0;return(t,o)=>{if(e){e=!1;try{t()}finally{e=!0}}else o!==void 0&&o()}};import*as S from "prosemirror-model";import{Plugin as zo,TextSelection as Ho}from "prosemirror-state";var C=Math.floor;var N=(e,t)=>e<t?e:t,ke=(e,t)=>e>t?e:t,En=Number.isNaN;var O=Symbol("Equality"),lt=(e,t)=>e===t||!!e?.[O]?.(t)||!1;var ut=e=>typeof e=="object";var Pe=Object.keys;var $e=e=>Pe(e).length;var j=(e,t)=>{for(let o in e)if(!t(e[o],o))return!1;return!0},oe=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var pt=()=>new Set;var ne=(e,t)=>{for(let o=0;o<e.length;o++)if(!t(e[o],o,e))return!1;return!0},Me=(e,t)=>{for(let o=0;o<e.length;o++)if(t(e[o],o,e))return!0;return!1};var ft=(e,t)=>{let o=new Array(e);for(let n=0;n<e;n++)o[n]=t(n,o);return o};var re=Array.isArray;var q=(e,t)=>{if(e===t)return!0;if(e==null||t==null||e.constructor!==t.constructor&&(e.constructor||Object)!==(t.constructor||Object))return!1;if(e[O]!=null)return e[O](t);switch(e.constructor){case ArrayBuffer:e=new Uint8Array(e),t=new Uint8Array(t);case Uint8Array:{if(e.byteLength!==t.byteLength)return!1;for(let o=0;o<e.length;o++)if(e[o]!==t[o])return!1;break}case Set:{if(e.size!==t.size)return!1;for(let o of e)if(!t.has(o))return!1;break}case Map:{if(e.size!==t.size)return!1;for(let o of e.keys())if(!t.has(o)||!q(e.get(o),t.get(o)))return!1;break}case void 0:case Object:if($e(e)!==$e(t))return!1;for(let o in e)if(!oe(e,o)||!q(e[o],t[o]))return!1;break;case Array:if(e.length!==t.length)return!1;for(let o=0;o<e.length;o++)if(!q(e[o],t[o]))return!1;break;default:return!1}return!0},ht=(e,t)=>t.includes(e);var Zt=/[\uD800-\uDBFF]/,Qt=/[\uDC00-\uDFFF]/,eo=(e,t)=>{let o=0,n=0;for(;o<e.length&&o<t.length&&e[o]===t[o];)o++;for(o>0&&Zt.test(e[o-1])&&o--;n+o<e.length&&n+o<t.length&&e[e.length-n-1]===t[t.length-n-1];)n++;return n>0&&Qt.test(e[e.length-n])&&n--,{index:o,remove:e.length-o-n,insert:t.slice(o,t.length-n)}},xt=eo;var L=e=>new Error(e),se=()=>{throw L("Method unimplemented")},V=()=>{throw L("Unexpected case")};import{PluginKey as Re}from "prosemirror-state";var m=new Re("y-sync"),w=new Re("y-undo"),X=new Re("yjs-cursor");import*as d from "yjs";var to=Math.random;var gt=e=>e[C(to()*e.length)],On="10000000-1000-4000-8000"+-1e11;var $=()=>new Map;var yt=(e,t,o)=>{let n=e.get(t);return n===void 0&&e.set(t,n=o()),n};var De=String.fromCharCode,no=String.fromCodePoint,kn=De(65535),ro=e=>e.toLowerCase(),so=/^\s*/g,io=e=>e.replace(so,""),co=/([A-Z])/g,Ue=(e,t)=>io(e.replace(co,o=>`${t}${ro(o)}`));var Pn=typeof TextEncoder<"u"?new TextEncoder:null;var Ie=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});Ie&&Ie.decode(new Uint8Array).length===1&&(Ie=null);var _t=(e,t)=>ft(t,()=>e).join("");var Fe=e=>e===void 0?null:e;var je=class{constructor(){this.map=new Map}setItem(t,o){this.map.set(t,o)}getItem(t){return this.map.get(t)}},bt=new je,ao=!0;try{typeof localStorage<"u"&&localStorage&&(bt=localStorage,ao=!1)}catch{}var Et=bt;var v=typeof __Process$<"u"&&__Process$.release&&/node|io\.js/.test(__Process$.release.name)&&Object.prototype.toString.call(typeof __Process$<"u"?__Process$:0)==="[object process]",wt=typeof window<"u"&&typeof document<"u"&&!v,$n=typeof navigator<"u"?/Mac/.test(navigator.platform):!1,_,po=[],fo=()=>{if(_===void 0)if(v){_=$();let e=__Process$.argv,t=null;for(let o=0;o<e.length;o++){let n=e[o];n[0]==="-"?(t!==null&&_.set(t,""),t=n):t!==null?(_.set(t,n),t=null):po.push(n)}t!==null&&_.set(t,"")}else typeof location=="object"?(_=$(),(location.search||"?").slice(1).split("&").forEach(e=>{if(e.length!==0){let[t,o]=e.split("=");_.set(`--${Ue(t,"-")}`,o),_.set(`-${Ue(t,"-")}`,o)}})):_=$();return _},qe=e=>fo().has(e);var Le=e=>v?Fe(__Process$.env[e.toUpperCase().replaceAll("-","_")]):Fe(Et.getItem(e));var At=e=>qe("--"+e)||Le(e)!==null,Ct=At("production"),ho=v&&ht(__Process$.env.FORCE_COLOR,["true","1","2"]),vn=ho||!qe("--no-colors")&&!At("no-color")&&(!v||__Process$.stdout.isTTY)&&(!v||qe("--color")||Le("COLORTERM")!==null||(Le("TERM")||"").includes("color"));var Ve=Number.MAX_SAFE_INTEGER,Xe=Number.MIN_SAFE_INTEGER,Mn=1<<31;var Yn=Number.isInteger||(e=>typeof e=="number"&&isFinite(e)&&C(e)===e),Rn=Number.isNaN,In=Number.parseInt;var Be=e=>e.next()>=.5,ie=(e,t,o)=>C(e.next()*(o+1-t)+t);var ze=(e,t,o)=>C(e.next()*(o+1-t)+t);var He=(e,t,o)=>ze(e,t,o);var xo=e=>De(He(e,97,122)),Ot=(e,t=0,o=20)=>{let n=He(e,t,o),r="";for(let i=0;i<n;i++)r+=xo(e);return r};var ce=(e,t)=>t[He(e,0,t.length-1)];var yo=Symbol("0schema"),Je=class{constructor(){this._rerrs=[]}extend(t,o,n,r=null){this._rerrs.push({path:t,expected:o,has:n,message:r})}toString(){let t=[];for(let o=this._rerrs.length-1;o>0;o--){let n=this._rerrs[o];t.push(_t(" ",(this._rerrs.length-o)*2)+`${n.path!=null?`[${n.path}] `:""}${n.has} doesn't match ${n.expected}. ${n.message}`)}return t.join(`
`)}},Ke=(e,t)=>e===t?!0:e==null||t==null||e.constructor!==t.constructor?!1:e[O]?lt(e,t):re(e)?ne(e,o=>Me(t,n=>Ke(o,n))):ut(e)?j(e,(o,n)=>Ke(o,t[n])):!1,T=class{static _dilutes=!1;extends(t){let[o,n]=[this.shape,t.shape];return this.constructor._dilutes&&([n,o]=[o,n]),Ke(o,n)}equals(t){return this.constructor===t.constructor&&q(this.shape,t.shape)}[yo](){return!0}[O](t){return this.equals(t)}validate(t){return this.check(t)}check(t,o){se()}get nullable(){return D(this,Te)}get optional(){return new le(this)}cast(t){return kt(t,this),t}expect(t){return kt(t,this),t}},B=class extends T{constructor(t,o){super(),this.shape=t,this._c=o}check(t,o=void 0){let n=t?.constructor===this.shape&&(this._c==null||this._c(t));return!n&&o?.extend(null,this.shape.name,t?.constructor.name,t?.constructor!==this.shape?"Constructor match failed":"Check failed"),n}},g=(e,t=null)=>new B(e,t),Fn=g(B),z=class extends T{constructor(t){super(),this.shape=t}check(t,o){let n=this.shape(t);return!n&&o?.extend(null,"custom prop",t?.constructor.name,"failed to check custom prop"),n}},y=e=>new z(e),jn=g(z),R=class extends T{constructor(t){super(),this.shape=t}check(t,o){let n=this.shape.some(r=>r===t);return!n&&o?.extend(null,this.shape.join(" | "),t.toString()),n}},ge=(...e)=>new R(e),Pt=g(R),To=RegExp.escape||(e=>e.replace(/[().|&,$^[\]]/g,t=>"\\"+t)),$t=e=>{if(I.check(e))return[To(e)];if(Pt.check(e))return e.shape.map(t=>t+"");if(It.check(e))return["[+-]?\\d+.?\\d*"];if(Dt.check(e))return[".*"];if(me.check(e))return e.shape.map($t).flat(1);V()},Ge=class extends T{constructor(t){super(),this.shape=t,this._r=new RegExp("^"+t.map($t).map(o=>`(${o.join("|")})`).join("")+"$")}check(t,o){let n=this._r.exec(t)!=null;return!n&&o?.extend(null,this._r.toString(),t.toString(),"String doesn't match string template."),n}};var qn=g(Ge),_o=Symbol("optional"),le=class extends T{constructor(t){super(),this.shape=t}check(t,o){let n=t===void 0||this.shape.check(t);return!n&&o?.extend(null,"undefined (optional)","()"),n}get[_o](){return!0}},So=g(le),ae=class extends T{check(t,o){return o?.extend(null,"never",typeof t),!1}},Ln=new ae,Vn=g(ae),ue=class e extends T{constructor(t,o=!1){super(),this.shape=t,this._isPartial=o}static _dilutes=!0;get partial(){return new e(this.shape,!0)}check(t,o){return t==null?(o?.extend(null,"object","null"),!1):j(this.shape,(n,r)=>{let i=this._isPartial&&!oe(t,r)||n.check(t[r],o);return!i&&o?.extend(r.toString(),n.toString(),typeof t[r],"Object property does not match"),i})}},bo=e=>new ue(e),Eo=g(ue),wo=y(e=>e!=null&&(e.constructor===Object||e.constructor==null)),pe=class extends T{constructor(t,o){super(),this.shape={keys:t,values:o}}check(t,o){return t!=null&&j(t,(n,r)=>{let i=this.shape.keys.check(r,o);return!i&&o?.extend(r+"","Record",typeof t,i?"Key doesn't match schema":"Value doesn't match value"),i&&this.shape.values.check(n,o)})}},vt=(e,t)=>new pe(e,t),Ao=g(pe),fe=class extends T{constructor(t){super(),this.shape=t}check(t,o){return t!=null&&j(this.shape,(n,r)=>{let i=n.check(t[r],o);return!i&&o?.extend(r.toString(),"Tuple",typeof n),i})}},Co=(...e)=>new fe(e),Xn=g(fe),de=class extends T{constructor(t){super(),this.shape=t.length===1?t[0]:new H(t)}check(t,o){let n=re(t)&&ne(t,r=>this.shape.check(r));return!n&&o?.extend(null,"Array",""),n}},Mt=(...e)=>new de(e),No=g(de),Oo=y(e=>re(e)),he=class extends T{constructor(t,o){super(),this.shape=t,this._c=o}check(t,o){let n=t instanceof this.shape&&(this._c==null||this._c(t));return!n&&o?.extend(null,this.shape.name,t?.constructor.name),n}},ko=(e,t=null)=>new he(e,t),Bn=g(he),Po=ko(T),We=class extends T{constructor(t){super(),this.len=t.length-1,this.args=Co(...t.slice(-1)),this.res=t[this.len]}check(t,o){let n=t.constructor===Function&&t.length<=this.len;return!n&&o?.extend(null,"function",typeof t),n}};var $o=g(We),vo=y(e=>typeof e=="function"),Ze=class extends T{constructor(t){super(),this.shape=t}check(t,o){let n=ne(this.shape,r=>r.check(t,o));return!n&&o?.extend(null,"Intersectinon",typeof t),n}};var zn=g(Ze,e=>e.shape.length>0),H=class extends T{static _dilutes=!0;constructor(t){super(),this.shape=t}check(t,o){let n=Me(this.shape,r=>r.check(t,o));return o?.extend(null,"Union",typeof t),n}},D=(...e)=>e.findIndex(t=>me.check(t))>=0?D(...e.map(t=>J(t)).map(t=>me.check(t)?t.shape:[t]).flat(1)):e.length===1?e[0]:new H(e),me=g(H),Yt=()=>!0,xe=y(Yt),Mo=g(z,e=>e.shape===Yt),et=y(e=>typeof e=="bigint"),Yo=y(e=>e===et),Rt=y(e=>typeof e=="symbol"),Hn=y(e=>e===Rt),Y=y(e=>typeof e=="number"),It=y(e=>e===Y),I=y(e=>typeof e=="string"),Dt=y(e=>e===I),ye=y(e=>typeof e=="boolean"),Ro=y(e=>e===ye),Ut=ge(void 0),Jn=g(R,e=>e.shape.length===1&&e.shape[0]===void 0),Kn=ge(void 0);var Te=ge(null),Io=g(R,e=>e.shape.length===1&&e.shape[0]===null),Gn=g(Uint8Array),Wn=g(B,e=>e.shape===Uint8Array),Do=D(Y,I,Te,Ut,et,ye,Rt),Zn=(()=>{let e=Mt(xe),t=vt(I,xe),o=D(Y,I,Te,ye,e,t);return e.shape=o,t.shape.values=o,o})(),J=e=>{if(Po.check(e))return e;if(wo.check(e)){let t={};for(let o in e)t[o]=J(e[o]);return bo(t)}else{if(Oo.check(e))return D(...e.map(J));if(Do.check(e))return ge(e);if(vo.check(e))return g(e)}V()},kt=Ct?()=>{}:(e,t)=>{let o=new Je;if(!t.check(e,o))throw L(`Expected value to be of type ${t.constructor.name}.
${o.toString()}`)},Qe=class{constructor(t){this.patterns=[],this.$state=t}if(t,o){return this.patterns.push({if:J(t),h:o}),this}else(t){return this.if(xe,t)}done(){return(t,o)=>{for(let n=0;n<this.patterns.length;n++){let r=this.patterns[n];if(r.if.check(t))return r.h(t,o)}throw L("Unhandled pattern")}}},Uo=e=>new Qe(e),Ft=Uo(xe).if(It,(e,t)=>ie(t,Xe,Ve)).if(Dt,(e,t)=>Ot(t)).if(Ro,(e,t)=>Be(t)).if(Yo,(e,t)=>BigInt(ie(t,Xe,Ve))).if(me,(e,t)=>M(t,ce(t,e.shape))).if(Eo,(e,t)=>{let o={};for(let n in e.shape){let r=e.shape[n];if(So.check(r)){if(Be(t))continue;r=r.shape}o[n]=Ft(r,t)}return o}).if(No,(e,t)=>{let o=[],n=ze(t,0,42);for(let r=0;r<n;r++)o.push(M(t,e.shape));return o}).if(Pt,(e,t)=>ce(t,e.shape)).if(Io,(e,t)=>null).if($o,(e,t)=>{let o=M(t,e.res);return()=>o}).if(Mo,(e,t)=>M(t,ce(t,[Y,I,Te,Ut,et,ye,Mt(Y),vt(D("a","b","c"),Y)]))).if(Ao,(e,t)=>{let o={},n=ie(t,0,3);for(let r=0;r<n;r++){let i=M(t,e.shape.keys),c=M(t,e.shape.values);o[i]=c}return o}).done(),M=(e,t)=>Ft(J(t),e);var b=typeof document<"u"?document:{};var Qn=y(e=>e.nodeType===Vo);var er=typeof DOMParser<"u"?new DOMParser:null;var tr=y(e=>e.nodeType===jo);var or=y(e=>e.nodeType===qo);var jo=b.ELEMENT_NODE,qo=b.TEXT_NODE,nr=b.CDATA_SECTION_NODE,rr=b.COMMENT_NODE,Lo=b.DOCUMENT_NODE,sr=b.DOCUMENT_TYPE_NODE,Vo=b.DOCUMENT_FRAGMENT_NODE,ir=y(e=>e.nodeType===Lo);var _e=e=>class{constructor(o){this._=o}destroy(){e(this._)}},Bo=_e(clearTimeout),U=(e,t)=>new Bo(setTimeout(t,e)),lr=_e(clearInterval);var ar=_e(e=>typeof requestAnimationFrame<"u"&&cancelAnimationFrame(e));var ur=_e(e=>typeof cancelIdleCallback<"u"&&cancelIdleCallback(e));var K=(e,t)=>t===void 0?!e.deleted:t.sv.has(e.id.client)&&t.sv.get(e.id.client)>e.id.clock&&!d.isDeleted(t.ds,e.id),Jo=[{light:"#ecd44433",dark:"#ecd444"}],Ko=(e,t,o)=>{if(!e.has(o)){if(e.size<t.length){let n=pt();e.forEach(r=>n.add(r)),t=t.filter(r=>!n.has(r))}e.set(o,gt(t))}return e.get(o)},Go=(e,{colors:t=Jo,colorMapping:o=new Map,permanentUserData:n=null,onFirstRender:r=()=>{}}={})=>{let i=!1,c,a=new zo({props:{editable:l=>{let s=m.getState(l);return s.snapshot==null&&s.prevSnapshot==null}},key:m,state:{init:(l,s)=>({type:e,doc:e.doc,binding:null,snapshot:null,prevSnapshot:null,isChangeOrigin:!1,isUndoRedoOperation:!1,addToHistory:!0,colors:t,colorMapping:o,permanentUserData:n}),apply:(l,s)=>{let u=l.getMeta(m);if(u!==void 0){s=Object.assign({},s);for(let p in u)s[p]=u[p]}return s.addToHistory=l.getMeta("addToHistory")!==!1,s.isChangeOrigin=u!==void 0&&!!u.isChangeOrigin,s.isUndoRedoOperation=u!==void 0&&!!u.isChangeOrigin&&!!u.isUndoRedoOperation,s.binding!==null&&u!==void 0&&(u.snapshot!=null||u.prevSnapshot!=null)&&U(0,()=>{s.binding==null||s.binding.isDestroyed||(u.restore==null?s.binding._renderSnapshot(u.snapshot,u.prevSnapshot,s):(s.binding._renderSnapshot(u.snapshot,u.snapshot,s),delete s.restore,delete s.snapshot,delete s.prevSnapshot,s.binding.mux(()=>{s.binding._prosemirrorChanged(s.binding.prosemirrorView.state.doc)})))}),s}},view:l=>{let s=new be(e,l);return c?.destroy(),c=U(0,()=>{s._forceRerender(),l.dispatch(l.state.tr.setMeta(m,{binding:s})),r()}),{update:()=>{let u=a.getState(l.state);if(u.snapshot==null&&u.prevSnapshot==null&&(i||l.state.doc.content.findDiffStart(l.state.doc.type.createAndFill().content)!==null)){if(i=!0,u.addToHistory===!1&&!u.isChangeOrigin){let p=w.getState(l.state),f=p&&p.undoManager;f&&f.stopCapturing()}s.mux(()=>{u.doc.transact(p=>{p.meta.set("addToHistory",u.addToHistory),s._prosemirrorChanged(l.state.doc)},m)})}},destroy:()=>{c.destroy(),s.destroy()}}}});return a},Wo=(e,t,o)=>{if(t!==null&&t.anchor!==null&&t.head!==null){let n=A(o.doc,o.type,t.anchor,o.mapping),r=A(o.doc,o.type,t.head,o.mapping);n!==null&&r!==null&&(e=e.setSelection(Ho.create(e.doc,n,r)))}},G=(e,t)=>({anchor:k(t.selection.anchor,e.type,e.mapping),head:k(t.selection.head,e.type,e.mapping)}),be=class{constructor(t,o){this.type=t,this.prosemirrorView=o,this.mux=ct(),this.isDestroyed=!1,this.mapping=new Map,this._observeFunction=this._typeChanged.bind(this),this.doc=t.doc,this.beforeTransactionSelection=null,this.beforeAllTransactions=()=>{this.beforeTransactionSelection===null&&(this.beforeTransactionSelection=G(this,o.state))},this.afterAllTransactions=()=>{this.beforeTransactionSelection=null},this.doc.on("beforeAllTransactions",this.beforeAllTransactions),this.doc.on("afterAllTransactions",this.afterAllTransactions),t.observeDeep(this._observeFunction),this._domSelectionInView=null}get _tr(){return this.prosemirrorView.state.tr.setMeta("addToHistory",!1)}_isLocalCursorInView(){return this.prosemirrorView.hasFocus()?(wt&&this._domSelectionInView===null&&(U(0,()=>{this._domSelectionInView=null}),this._domSelectionInView=this._isDomSelectionInView()),this._domSelectionInView):!1}_isDomSelectionInView(){let t=this.prosemirrorView._root.getSelection(),o=this.prosemirrorView._root.createRange();o.setStart(t.anchorNode,t.anchorOffset),o.setEnd(t.focusNode,t.focusOffset),o.getClientRects().length===0&&o.startContainer&&o.collapsed&&o.selectNodeContents(o.startContainer);let r=o.getBoundingClientRect(),i=b.documentElement;return r.bottom>=0&&r.right>=0&&r.left<=(window.innerWidth||i.clientWidth||0)&&r.top<=(window.innerHeight||i.clientHeight||0)}renderSnapshot(t,o){o||(o=d.createSnapshot(d.createDeleteSet(),new Map)),this.prosemirrorView.dispatch(this._tr.setMeta(m,{snapshot:t,prevSnapshot:o}))}unrenderSnapshot(){this.mapping=new Map,this.mux(()=>{let t=this.type.toArray().map(n=>Se(n,this.prosemirrorView.state.schema,this.mapping)).filter(n=>n!==null),o=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new S.Slice(S.Fragment.from(t),0,0));o.setMeta(m,{snapshot:null,prevSnapshot:null}),this.prosemirrorView.dispatch(o)})}_forceRerender(){this.mapping=new Map,this.mux(()=>{let t=this.type.toArray().map(n=>Se(n,this.prosemirrorView.state.schema,this.mapping)).filter(n=>n!==null),o=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new S.Slice(S.Fragment.from(t),0,0));this.prosemirrorView.dispatch(o.setMeta(m,{isChangeOrigin:!0}))})}_renderSnapshot(t,o,n){t||(t=d.snapshot(this.doc)),this.mapping=new Map,this.mux(()=>{this.doc.transact(r=>{let i=n.permanentUserData;i&&i.dss.forEach(s=>{d.iterateDeletedStructs(r,s,u=>{})});let c=(s,u)=>{let p=s==="added"?i.getUserByClientId(u.client):i.getUserByDeletedId(u);return{user:p,type:s,color:Ko(n.colorMapping,n.colors,p)}},a=d.typeListToArraySnapshot(this.type,new d.Snapshot(o.ds,t.sv)).map(s=>!s._item.deleted||K(s._item,t)||K(s._item,o)?Se(s,this.prosemirrorView.state.schema,new Map,t,o,c):null).filter(s=>s!==null),l=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new S.Slice(S.Fragment.from(a),0,0));this.prosemirrorView.dispatch(l.setMeta(m,{isChangeOrigin:!0}))},m)})}_typeChanged(t,o){let n=m.getState(this.prosemirrorView.state);if(t.length===0||n.snapshot!=null||n.prevSnapshot!=null){this.renderSnapshot(n.snapshot,n.prevSnapshot);return}this.mux(()=>{let r=(a,l)=>this.mapping.delete(l);d.iterateDeletedStructs(o,o.deleteSet,a=>{if(a.constructor===d.Item){let l=a.content.type;l&&this.mapping.delete(l)}}),o.changed.forEach(r),o.changedParentTypes.forEach(r);let i=this.type.toArray().map(a=>Vt(a,this.prosemirrorView.state.schema,this.mapping)).filter(a=>a!==null),c=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new S.Slice(S.Fragment.from(i),0,0));Wo(c,this.beforeTransactionSelection,this),c=c.setMeta(m,{isChangeOrigin:!0,isUndoRedoOperation:o.origin instanceof d.UndoManager}),this.beforeTransactionSelection!==null&&this._isLocalCursorInView()&&c.scrollIntoView(),this.prosemirrorView.dispatch(c)})}_prosemirrorChanged(t){this.doc.transact(()=>{Z(this.doc,this.type,t,this.mapping),this.beforeTransactionSelection=G(this,this.prosemirrorView.state)},m)}destroy(){this.isDestroyed=!0,this.type.unobserveDeep(this._observeFunction),this.doc.off("beforeAllTransactions",this.beforeAllTransactions),this.doc.off("afterAllTransactions",this.afterAllTransactions)}},Vt=(e,t,o,n,r,i)=>{let c=o.get(e);if(c===void 0){if(e instanceof d.XmlElement)return Se(e,t,o,n,r,i);throw se()}return c},Se=(e,t,o,n,r,i)=>{let c=[],a=l=>{if(l.constructor===d.XmlElement){let s=Vt(l,t,o,n,r,i);s!==null&&c.push(s)}else{let s=Zo(l,t,o,n,r,i);s!==null&&s.forEach(u=>{u!==null&&c.push(u)})}};n===void 0||r===void 0?e.toArray().forEach(a):d.typeListToArraySnapshot(e,new d.Snapshot(r.ds,n.sv)).forEach(a);try{let l=e.getAttributes(n);n!==void 0&&(K(e._item,n)?K(e._item,r)||(l.ychange=i?i("added",e._item.id):{type:"added"}):l.ychange=i?i("removed",e._item.id):{type:"removed"});let s=t.node(e.nodeName,l,c);return o.set(e,s),s}catch{return e.doc.transact(s=>{e._item.delete(s)},m),o.delete(e),null}},Zo=(e,t,o,n,r,i)=>{let c=[],a=e.toDelta(n,r,i);try{for(let l=0;l<a.length;l++){let s=a[l],u=[];for(let p in s.attributes)u.push(t.mark(p,s.attributes[p]));c.push(t.text(s.insert,u))}}catch{return e.doc.transact(s=>{e._item.delete(s)},m),null}return c},Qo=(e,t)=>{let o=new d.XmlText,n=e.map(r=>({insert:r.text,attributes:Bt(r.marks)}));return o.applyDelta(n),t.set(o,e),o},en=(e,t)=>{let o=new d.XmlElement(e.type.name);for(let n in e.attrs){let r=e.attrs[n];r!==null&&n!=="ychange"&&o.setAttribute(n,r)}return o.insert(0,we(e).map(n=>tt(n,t))),t.set(o,e),o},tt=(e,t)=>e instanceof Array?Qo(e,t):en(e,t),qt=e=>typeof e=="object"&&e!==null,nt=(e,t)=>{let o=Object.keys(e).filter(r=>e[r]!==null),n=o.length===Object.keys(t).filter(r=>t[r]!==null).length;for(let r=0;r<o.length&&n;r++){let i=o[r],c=e[i],a=t[i];n=i==="ychange"||c===a||qt(c)&&qt(a)&&nt(c,a)}return n},we=e=>{let t=e.content.content,o=[];for(let n=0;n<t.length;n++){let r=t[n];if(r.isText){let i=[];for(let c=t[n];n<t.length&&c.isText;c=t[++n])i.push(c);n--,o.push(i)}else o.push(r)}return o},Xt=(e,t)=>{let o=e.toDelta();return o.length===t.length&&o.every((n,r)=>n.insert===t[r].text&&Pe(n.attributes||{}).length===t[r].marks.length&&t[r].marks.every(i=>nt(n.attributes[i.type.name]||{},i.attrs)))},W=(e,t)=>{if(e instanceof d.XmlElement&&!(t instanceof Array)&&ot(e,t)){let o=we(t);return e._length===o.length&&nt(e.getAttributes(),t.attrs)&&e.toArray().every((n,r)=>W(n,o[r]))}return e instanceof d.XmlText&&t instanceof Array&&Xt(e,t)},Ee=(e,t)=>e===t||e instanceof Array&&t instanceof Array&&e.length===t.length&&e.every((o,n)=>t[n]===o),Lt=(e,t,o)=>{let n=e.toArray(),r=we(t),i=r.length,c=n.length,a=N(c,i),l=0,s=0,u=!1;for(;l<a;l++){let p=n[l],f=r[l];if(Ee(o.get(p),f))u=!0;else if(!W(p,f))break}for(;l+s<a;s++){let p=n[c-s-1],f=r[i-s-1];if(Ee(o.get(p),f))u=!0;else if(!W(p,f))break}return{equalityFactor:l+s,foundMappedChild:u}},tn=e=>{let t="",o=e._start,n={};for(;o!==null;)o.deleted||(o.countable&&o.content instanceof d.ContentString?t+=o.content.str:o.content instanceof d.ContentFormat&&(n[o.content.key]=null)),o=o.right;return{str:t,nAttrs:n}},on=(e,t,o)=>{o.set(e,t);let{nAttrs:n,str:r}=tn(e),i=t.map(s=>({insert:s.text,attributes:Object.assign({},n,Bt(s.marks))})),{insert:c,remove:a,index:l}=xt(r,i.map(s=>s.insert).join(""));e.delete(l,a),e.insert(l,c),e.applyDelta(i.map(s=>({retain:s.insert.length,attributes:s.attributes})))},Bt=e=>{let t={};return e.forEach(o=>{o.type.name!=="ychange"&&(t[o.type.name]=o.attrs)}),t},Z=(e,t,o,n)=>{if(t instanceof d.XmlElement&&t.nodeName!==o.type.name)throw new Error("node name mismatch!");if(n.set(t,o),t instanceof d.XmlElement){let p=t.getAttributes(),f=o.attrs;for(let x in f)f[x]!==null?p[x]!==f[x]&&x!=="ychange"&&t.setAttribute(x,f[x]):t.removeAttribute(x);for(let x in p)f[x]===void 0&&t.removeAttribute(x)}let r=we(o),i=r.length,c=t.toArray(),a=c.length,l=N(i,a),s=0,u=0;for(;s<l;s++){let p=c[s],f=r[s];if(!Ee(n.get(p),f))if(W(p,f))n.set(p,f);else break}for(;u+s+1<l;u++){let p=c[a-u-1],f=r[i-u-1];if(!Ee(n.get(p),f))if(W(p,f))n.set(p,f);else break}e.transact(()=>{for(;a-s-u>0&&i-s-u>0;){let f=c[s],x=r[s],P=c[a-u-1],Ce=r[i-u-1];if(f instanceof d.XmlText&&x instanceof Array)Xt(f,x)||on(f,x,n),s+=1;else{let ee=f instanceof d.XmlElement&&ot(f,x),te=P instanceof d.XmlElement&&ot(P,Ce);if(ee&&te){let Ne=Lt(f,x,n),Oe=Lt(P,Ce,n);Ne.foundMappedChild&&!Oe.foundMappedChild?te=!1:!Ne.foundMappedChild&&Oe.foundMappedChild||Ne.equalityFactor<Oe.equalityFactor?ee=!1:te=!1}ee?(Z(e,f,x,n),s+=1):te?(Z(e,P,Ce,n),u+=1):(n.delete(t.get(s)),t.delete(s,1),t.insert(s,[tt(x,n)]),s+=1)}}let p=a-s-u;if(a===1&&i===0&&c[0]instanceof d.XmlText?(n.delete(c[0]),c[0].delete(0,c[0].length)):p>0&&(t.slice(s,s+p).forEach(f=>n.delete(f)),t.delete(s,p)),s+u<i){let f=[];for(let x=s;x<i-u;x++)f.push(tt(r[x],n));t.insert(s,f)}},m)},ot=(e,t)=>!(t instanceof Array)&&e.nodeName===t.type.name;import*as h from "yjs";import "prosemirror-view";import{Node as Ae}from "prosemirror-model";var Q=null,nn=()=>{let e=Q;Q=null,e.forEach((t,o)=>{let n=o.state.tr,r=m.getState(o.state);r&&r.binding&&!r.binding.isDestroyed&&(t.forEach((i,c)=>{n.setMeta(c,i)}),o.dispatch(n))})},rt=(e,t,o)=>{Q||(Q=new Map,U(0,nn)),yt(Q,e,$).set(t,o)},k=(e,t,o)=>{if(e===0)return h.createRelativePositionFromTypeIndex(t,0);let n=t._first===null?null:t._first.content.type;for(;n!==null&&t!==n;){if(n instanceof h.XmlText){if(n._length>=e)return h.createRelativePositionFromTypeIndex(n,e);if(e-=n._length,n._item!==null&&n._item.next!==null)n=n._item.next.content.type;else{do n=n._item===null?null:n._item.parent,e--;while(n!==t&&n!==null&&n._item!==null&&n._item.next===null);n!==null&&n!==t&&(n=n._item===null?null:n._item.next.content.type)}}else{let r=(o.get(n)||{nodeSize:0}).nodeSize;if(n._first!==null&&e<r)n=n._first.content.type,e--;else{if(e===1&&n._length===0&&r>1)return new h.RelativePosition(n._item===null?null:n._item.id,n._item===null?h.findRootTypeKey(n):null,null);if(e-=r,n._item!==null&&n._item.next!==null)n=n._item.next.content.type;else{if(e===0)return n=n._item===null?n:n._item.parent,new h.RelativePosition(n._item===null?null:n._item.id,n._item===null?h.findRootTypeKey(n):null,null);do n=n._item.parent,e--;while(n!==t&&n._item.next===null);n!==t&&(n=n._item.next.content.type)}}}if(n===null)throw V();if(e===0&&n.constructor!==h.XmlText&&n!==t)return rn(n._item.parent,n._item)}return h.createRelativePositionFromTypeIndex(t,t._length)},rn=(e,t)=>{let o=null,n=null;return e._item===null?n=h.findRootTypeKey(e):o=h.createID(e._item.id.client,e._item.id.clock),new h.RelativePosition(o,n,t.id)},A=(e,t,o,n)=>{let r=h.createAbsolutePositionFromRelativePosition(o,e);if(r===null||r.type!==t&&!h.isParentOf(t,r.type._item))return null;let i=r.type,c=0;if(i.constructor===h.XmlText)c=r.index;else if(i._item===null||!i._item.deleted){let a=i._first,l=0;for(;l<i._length&&l<r.index&&a!==null;){if(!a.deleted){let s=a.content.type;l++,s instanceof h.XmlText?c+=s._length:c+=n.get(s).nodeSize}a=a.right}c+=1}for(;i!==t&&i._item!==null;){let a=i._item.parent;if(a._item===null||!a._item.deleted){c+=1;let l=a._first;for(;l!==null;){let s=l.content.type;if(s===i)break;l.deleted||(s instanceof h.XmlText?c+=s._length:c+=n.get(s).nodeSize),l=l.right}}i=a}return c-1};function zt(e,t="prosemirror"){let o=new h.Doc,n=o.get(t,h.XmlFragment);return n.doc?(st(e,n),n.doc):o}function st(e,t){let o=t||new h.XmlFragment,n=o.doc?o.doc:{transact:r=>r(void 0)};return Z(n,o,e,new Map),o}function sn(e,t,o="prosemirror"){let n=Ae.fromJSON(e,t);return zt(n,o)}function cn(e,t,o){let n=Ae.fromJSON(e,t);return st(n,o)}function ln(e,t){let o=Ht(t);return Ae.fromJSON(e,o)}function an(e,t){let o=it(t);return Ae.fromJSON(e,o)}function Ht(e,t="prosemirror"){return it(e.getXmlFragment(t))}function it(e){let t=e.toArray();function o(n){let r;if(!n.nodeName)r=n.toDelta().map(c=>{let a={type:"text",text:c.insert};return c.attributes&&(a.marks=Object.keys(c.attributes).map(l=>{let s=c.attributes[l],u={type:l};return Object.keys(s)&&(u.attrs=s),u})),a});else{r={type:n.nodeName};let i=n.getAttributes();Object.keys(i).length&&(r.attrs=i);let c=n.toArray();c.length&&(r.content=c.map(o).flat())}return r}return{type:"doc",content:t.map(o)}}var pn=e=>{let t=document.createElement("span");t.classList.add("ProseMirror-yjs-cursor"),t.setAttribute("style",`border-color: ${e.color}`);let o=document.createElement("div");o.setAttribute("style",`background-color: ${e.color}`),o.insertBefore(document.createTextNode(e.name),null);let n=document.createTextNode("\u2060"),r=document.createTextNode("\u2060");return t.insertBefore(n,null),t.insertBefore(o,null),t.insertBefore(r,null),t},fn=e=>({style:`background-color: ${e.color}70`,class:"ProseMirror-yjs-selection"}),dn=/^#[0-9a-fA-F]{6}$/,Gt=(e,t,o,n)=>{let r=m.getState(e),i=r.doc,c=[];return r.snapshot!=null||r.prevSnapshot!=null||r.binding===null?Kt.create(e.doc,[]):(t.getStates().forEach((a,l)=>{if(l!==i.clientID&&a.cursor!=null){let s=a.user||{};s.color==null?s.color="#ffa500":dn.test(s.color)||console.warn("A user uses an unsupported color format",s),s.name==null&&(s.name=`User: ${l}`);let u=A(i,r.type,E.createRelativePositionFromJSON(a.cursor.anchor),r.binding.mapping),p=A(i,r.type,E.createRelativePositionFromJSON(a.cursor.head),r.binding.mapping);if(u!==null&&p!==null){let f=ke(e.doc.content.size-1,0);u=N(u,f),p=N(p,f),c.push(Jt.widget(p,()=>o(s),{key:l+"",side:10}));let x=N(u,p),P=ke(u,p);c.push(Jt.inline(x,P,n(s),{inclusiveEnd:!0,inclusiveStart:!1}))}}}),Kt.create(e.doc,c))},Pr=(e,{cursorBuilder:t=pn,selectionBuilder:o=fn,getSelection:n=i=>i.selection}={},r="cursor")=>new un({key:X,state:{init(i,c){return Gt(c,e,t,o)},apply(i,c,a,l){let s=m.getState(l),u=i.getMeta(X);return s&&s.isChangeOrigin||u&&u.awarenessUpdated?Gt(l,e,t,o):c.map(i.mapping,i.doc)}},props:{decorations:i=>X.getState(i)},view:i=>{let c=()=>{i.docView&&rt(i,X,{awarenessUpdated:!0})},a=()=>{let l=m.getState(i.state),s=e.getLocalState()||{};if(l.binding!=null)if(i.hasFocus()){let u=n(i.state),p=k(u.anchor,l.type,l.binding.mapping),f=k(u.head,l.type,l.binding.mapping);(s.cursor==null||!E.compareRelativePositions(E.createRelativePositionFromJSON(s.cursor.anchor),p)||!E.compareRelativePositions(E.createRelativePositionFromJSON(s.cursor.head),f))&&e.setLocalStateField(r,{anchor:p,head:f})}else s.cursor!=null&&A(l.doc,l.type,E.createRelativePositionFromJSON(s.cursor.anchor),l.binding.mapping)!==null&&e.setLocalStateField(r,null)};return e.on("change",c),i.dom.addEventListener("focusin",a),i.dom.addEventListener("focusout",a),{update:a,destroy:()=>{i.dom.removeEventListener("focusin",a),i.dom.removeEventListener("focusout",a),e.off("change",c),e.setLocalStateField(r,null)}}}});import{Plugin as hn}from "prosemirror-state";import{UndoManager as mn,Item as xn,ContentType as gn,XmlElement as yn,Text as Tn}from "yjs";var Ir=e=>{let t=w.getState(e).undoManager;if(t!=null)return t.undo(),!0},Dr=e=>{let t=w.getState(e).undoManager;if(t!=null)return t.redo(),!0},_n=new Set(["paragraph"]),Sn=(e,t)=>!(e instanceof xn)||!(e.content instanceof gn)||!(e.content.type instanceof Tn||e.content.type instanceof yn&&t.has(e.content.type.nodeName))||e.content.type._length===0,Ur=({protectedNodes:e=_n,trackedOrigins:t=[],undoManager:o=null}={})=>new hn({key:w,state:{init:(n,r)=>{let i=m.getState(r),c=o||new mn(i.type,{trackedOrigins:new Set([m].concat(t)),deleteFilter:a=>Sn(a,e),captureTransaction:a=>a.meta.get("addToHistory")!==!1});return{undoManager:c,prevSel:null,hasUndoOps:c.undoStack.length>0,hasRedoOps:c.redoStack.length>0}},apply:(n,r,i,c)=>{let a=m.getState(c).binding,l=r.undoManager,s=l.undoStack.length>0,u=l.redoStack.length>0;return a?{undoManager:l,prevSel:G(a,i),hasUndoOps:s,hasRedoOps:u}:s!==r.hasUndoOps||u!==r.hasRedoOps?Object.assign({},r,{hasUndoOps:l.undoStack.length>0,hasRedoOps:l.redoStack.length>0}):r}},view:n=>{let r=m.getState(n.state),i=w.getState(n.state).undoManager;return i.on("stack-item-added",({stackItem:c})=>{let a=r.binding;a&&c.meta.set(a,w.getState(n.state).prevSel)}),i.on("stack-item-popped",({stackItem:c})=>{let a=r.binding;a&&(a.beforeTransactionSelection=c.meta.get(a)||a.beforeTransactionSelection)}),{destroy:()=>{i.destroy()}}}});export{be as ProsemirrorBinding,k as absolutePositionToRelativePosition,Gt as createDecorations,pn as defaultCursorBuilder,Sn as defaultDeleteFilter,_n as defaultProtectedNodes,fn as defaultSelectionBuilder,G as getRelativeSelection,K as isVisible,sn as prosemirrorJSONToYDoc,cn as prosemirrorJSONToYXmlFragment,zt as prosemirrorToYDoc,st as prosemirrorToYXmlFragment,Dr as redo,A as relativePositionToAbsolutePosition,rt as setMeta,Ir as undo,Pr as yCursorPlugin,X as yCursorPluginKey,ln as yDocToProsemirror,Ht as yDocToProsemirrorJSON,Go as ySyncPlugin,m as ySyncPluginKey,Ur as yUndoPlugin,w as yUndoPluginKey,an as yXmlFragmentToProsemirror,it as yXmlFragmentToProsemirrorJSON};
//# sourceMappingURL=y-prosemirror.bundle.mjs.map