/* esm.sh - prosemirror-state@1.4.3 */
function Ce(i,e,t){for(let n=0;;n++){if(n==i.childCount||n==e.childCount)return i.childCount==e.childCount?null:t;let r=i.child(n),s=e.child(n);if(r==s){t+=r.nodeSize;continue}if(!r.sameMarkup(s))return t;if(r.isText&&r.text!=s.text){for(let l=0;r.text[l]==s.text[l];l++)t++;return t}if(r.content.size||s.content.size){let l=Ce(r.content,s.content,t+1);if(l!=null)return l}t+=r.nodeSize}}function Te(i,e,t,n){for(let r=i.childCount,s=e.childCount;;){if(r==0||s==0)return r==s?null:{a:t,b:n};let l=i.child(--r),o=e.child(--s),a=l.nodeSize;if(l==o){t-=a,n-=a;continue}if(!l.sameMarkup(o))return{a:t,b:n};if(l.isText&&l.text!=o.text){let h=0,c=Math.min(l.text.length,o.text.length);for(;h<c&&l.text[l.text.length-h-1]==o.text[o.text.length-h-1];)h++,t--,n--;return{a:t,b:n}}if(l.content.size||o.content.size){let h=Te(l.content,o.content,t-1,n-1);if(h)return h}t-=a,n-=a}}var m=class i{constructor(e,t){if(this.content=e,this.size=t||0,t==null)for(let n=0;n<e.length;n++)this.size+=e[n].nodeSize}nodesBetween(e,t,n,r=0,s){for(let l=0,o=0;o<t;l++){let a=this.content[l],h=o+a.nodeSize;if(h>e&&n(a,r+o,s||null,l)!==!1&&a.content.size){let c=o+1;a.nodesBetween(Math.max(0,e-c),Math.min(a.content.size,t-c),n,r+c)}o=h}}descendants(e){this.nodesBetween(0,this.size,e)}textBetween(e,t,n,r){let s="",l=!0;return this.nodesBetween(e,t,(o,a)=>{let h=o.isText?o.text.slice(Math.max(e,a)-a,t-a):o.isLeaf?r?typeof r=="function"?r(o):r:o.type.spec.leafText?o.type.spec.leafText(o):"":"";o.isBlock&&(o.isLeaf&&h||o.isTextblock)&&n&&(l?l=!1:s+=n),s+=h},0),s}append(e){if(!e.size)return this;if(!this.size)return e;let t=this.lastChild,n=e.firstChild,r=this.content.slice(),s=0;for(t.isText&&t.sameMarkup(n)&&(r[r.length-1]=t.withText(t.text+n.text),s=1);s<e.content.length;s++)r.push(e.content[s]);return new i(r,this.size+e.size)}cut(e,t=this.size){if(e==0&&t==this.size)return this;let n=[],r=0;if(t>e)for(let s=0,l=0;l<t;s++){let o=this.content[s],a=l+o.nodeSize;a>e&&((l<e||a>t)&&(o.isText?o=o.cut(Math.max(0,e-l),Math.min(o.text.length,t-l)):o=o.cut(Math.max(0,e-l-1),Math.min(o.content.size,t-l-1))),n.push(o),r+=o.nodeSize),l=a}return new i(n,r)}cutByIndex(e,t){return e==t?i.empty:e==0&&t==this.content.length?this:new i(this.content.slice(e,t))}replaceChild(e,t){let n=this.content[e];if(n==t)return this;let r=this.content.slice(),s=this.size+t.nodeSize-n.nodeSize;return r[e]=t,new i(r,s)}addToStart(e){return new i([e].concat(this.content),this.size+e.nodeSize)}addToEnd(e){return new i(this.content.concat(e),this.size+e.nodeSize)}eq(e){if(this.content.length!=e.content.length)return!1;for(let t=0;t<this.content.length;t++)if(!this.content[t].eq(e.content[t]))return!1;return!0}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}child(e){let t=this.content[e];if(!t)throw new RangeError("Index "+e+" out of range for "+this);return t}maybeChild(e){return this.content[e]||null}forEach(e){for(let t=0,n=0;t<this.content.length;t++){let r=this.content[t];e(r,n,t),n+=r.nodeSize}}findDiffStart(e,t=0){return Ce(this,e,t)}findDiffEnd(e,t=this.size,n=e.size){return Te(this,e,t,n)}findIndex(e){if(e==0)return Q(0,e);if(e==this.size)return Q(this.content.length,e);if(e>this.size||e<0)throw new RangeError(`Position ${e} outside of fragment (${this})`);for(let t=0,n=0;;t++){let r=this.child(t),s=n+r.nodeSize;if(s>=e)return s==e?Q(t+1,s):Q(t,n);n=s}}toString(){return"<"+this.toStringInner()+">"}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map(e=>e.toJSON()):null}static fromJSON(e,t){if(!t)return i.empty;if(!Array.isArray(t))throw new RangeError("Invalid input for Fragment.fromJSON");return new i(t.map(e.nodeFromJSON))}static fromArray(e){if(!e.length)return i.empty;let t,n=0;for(let r=0;r<e.length;r++){let s=e[r];n+=s.nodeSize,r&&s.isText&&e[r-1].sameMarkup(s)?(t||(t=e.slice(0,r)),t[t.length-1]=s.withText(t[t.length-1].text+s.text)):t&&t.push(s)}return new i(t||e,n)}static from(e){if(!e)return i.empty;if(e instanceof i)return e;if(Array.isArray(e))return this.fromArray(e);if(e.attrs)return new i([e],e.nodeSize);throw new RangeError("Can not convert "+e+" to a Fragment"+(e.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}};m.empty=new m([],0);var ie={index:0,offset:0};function Q(i,e){return ie.index=i,ie.offset=e,ie}function X(i,e){if(i===e)return!0;if(!(i&&typeof i=="object")||!(e&&typeof e=="object"))return!1;let t=Array.isArray(i);if(Array.isArray(e)!=t)return!1;if(t){if(i.length!=e.length)return!1;for(let n=0;n<i.length;n++)if(!X(i[n],e[n]))return!1}else{for(let n in i)if(!(n in e)||!X(i[n],e[n]))return!1;for(let n in e)if(!(n in i))return!1}return!0}var S=class i{constructor(e,t){this.type=e,this.attrs=t}addToSet(e){let t,n=!1;for(let r=0;r<e.length;r++){let s=e[r];if(this.eq(s))return e;if(this.type.excludes(s.type))t||(t=e.slice(0,r));else{if(s.type.excludes(this.type))return e;!n&&s.type.rank>this.type.rank&&(t||(t=e.slice(0,r)),t.push(this),n=!0),t&&t.push(s)}}return t||(t=e.slice()),n||t.push(this),t}removeFromSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return e.slice(0,t).concat(e.slice(t+1));return e}isInSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return!0;return!1}eq(e){return this==e||this.type==e.type&&X(this.attrs,e.attrs)}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Mark.fromJSON");let n=e.marks[t.type];if(!n)throw new RangeError(`There is no mark type ${t.type} in this schema`);let r=n.create(t.attrs);return n.checkAttrs(r.attrs),r}static sameSet(e,t){if(e==t)return!0;if(e.length!=t.length)return!1;for(let n=0;n<e.length;n++)if(!e[n].eq(t[n]))return!1;return!0}static setFrom(e){if(!e||Array.isArray(e)&&e.length==0)return i.none;if(e instanceof i)return[e];let t=e.slice();return t.sort((n,r)=>n.type.rank-r.type.rank),t}};S.none=[];var R=class extends Error{},u=class i{constructor(e,t,n){this.content=e,this.openStart=t,this.openEnd=n}get size(){return this.content.size-this.openStart-this.openEnd}insertAt(e,t){let n=Re(this.content,e+this.openStart,t);return n&&new i(n,this.openStart,this.openEnd)}removeBetween(e,t){return new i(Ne(this.content,e+this.openStart,t+this.openStart),this.openStart,this.openEnd)}eq(e){return this.content.eq(e.content)&&this.openStart==e.openStart&&this.openEnd==e.openEnd}toString(){return this.content+"("+this.openStart+","+this.openEnd+")"}toJSON(){if(!this.content.size)return null;let e={content:this.content.toJSON()};return this.openStart>0&&(e.openStart=this.openStart),this.openEnd>0&&(e.openEnd=this.openEnd),e}static fromJSON(e,t){if(!t)return i.empty;let n=t.openStart||0,r=t.openEnd||0;if(typeof n!="number"||typeof r!="number")throw new RangeError("Invalid input for Slice.fromJSON");return new i(m.fromJSON(e,t.content),n,r)}static maxOpen(e,t=!0){let n=0,r=0;for(let s=e.firstChild;s&&!s.isLeaf&&(t||!s.type.spec.isolating);s=s.firstChild)n++;for(let s=e.lastChild;s&&!s.isLeaf&&(t||!s.type.spec.isolating);s=s.lastChild)r++;return new i(e,n,r)}};u.empty=new u(m.empty,0,0);function Ne(i,e,t){let{index:n,offset:r}=i.findIndex(e),s=i.maybeChild(n),{index:l,offset:o}=i.findIndex(t);if(r==e||s.isText){if(o!=t&&!i.child(l).isText)throw new RangeError("Removing non-flat range");return i.cut(0,e).append(i.cut(t))}if(n!=l)throw new RangeError("Removing non-flat range");return i.replaceChild(n,s.copy(Ne(s.content,e-r-1,t-r-1)))}function Re(i,e,t,n){let{index:r,offset:s}=i.findIndex(e),l=i.maybeChild(r);if(s==e||l.isText)return n&&!n.canReplace(r,r,t)?null:i.cut(0,e).append(t).append(i.cut(e));let o=Re(l.content,e-s-1,t,l);return o&&i.replaceChild(r,l.copy(o))}function lt(i,e,t){if(t.openStart>i.depth)throw new R("Inserted content deeper than insertion position");if(i.depth-t.openStart!=e.depth-t.openEnd)throw new R("Inconsistent open depths");return Ie(i,e,t,0)}function Ie(i,e,t,n){let r=i.index(n),s=i.node(n);if(r==e.index(n)&&n<i.depth-t.openStart){let l=Ie(i,e,t,n+1);return s.copy(s.content.replaceChild(r,l))}else if(t.content.size)if(!t.openStart&&!t.openEnd&&i.depth==n&&e.depth==n){let l=i.parent,o=l.content;return N(l,o.cut(0,i.parentOffset).append(t.content).append(o.cut(e.parentOffset)))}else{let{start:l,end:o}=ot(t,i);return N(s,ze(i,l,o,e,n))}else return N(s,Y(i,e,n))}function Ae(i,e){if(!e.type.compatibleContent(i.type))throw new R("Cannot join "+e.type.name+" onto "+i.type.name)}function se(i,e,t){let n=i.node(t);return Ae(n,e.node(t)),n}function T(i,e){let t=e.length-1;t>=0&&i.isText&&i.sameMarkup(e[t])?e[t]=i.withText(e[t].text+i.text):e.push(i)}function W(i,e,t,n){let r=(e||i).node(t),s=0,l=e?e.index(t):r.childCount;i&&(s=i.index(t),i.depth>t?s++:i.textOffset&&(T(i.nodeAfter,n),s++));for(let o=s;o<l;o++)T(r.child(o),n);e&&e.depth==t&&e.textOffset&&T(e.nodeBefore,n)}function N(i,e){return i.type.checkContent(e),i.copy(e)}function ze(i,e,t,n,r){let s=i.depth>r&&se(i,e,r+1),l=n.depth>r&&se(t,n,r+1),o=[];return W(null,i,r,o),s&&l&&e.index(r)==t.index(r)?(Ae(s,l),T(N(s,ze(i,e,t,n,r+1)),o)):(s&&T(N(s,Y(i,e,r+1)),o),W(e,t,r,o),l&&T(N(l,Y(t,n,r+1)),o)),W(n,null,r,o),new m(o)}function Y(i,e,t){let n=[];if(W(null,i,t,n),i.depth>t){let r=se(i,e,t+1);T(N(r,Y(i,e,t+1)),n)}return W(e,null,t,n),new m(n)}function ot(i,e){let t=e.depth-i.openStart,r=e.node(t).copy(i.content);for(let s=t-1;s>=0;s--)r=e.node(s).copy(m.from(r));return{start:r.resolveNoCache(i.openStart+t),end:r.resolveNoCache(r.content.size-i.openEnd-t)}}var Z=class i{constructor(e,t,n){this.pos=e,this.path=t,this.parentOffset=n,this.depth=t.length/3-1}resolveDepth(e){return e==null?this.depth:e<0?this.depth+e:e}get parent(){return this.node(this.depth)}get doc(){return this.node(0)}node(e){return this.path[this.resolveDepth(e)*3]}index(e){return this.path[this.resolveDepth(e)*3+1]}indexAfter(e){return e=this.resolveDepth(e),this.index(e)+(e==this.depth&&!this.textOffset?0:1)}start(e){return e=this.resolveDepth(e),e==0?0:this.path[e*3-1]+1}end(e){return e=this.resolveDepth(e),this.start(e)+this.node(e).content.size}before(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position before the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]}after(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position after the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]+this.path[e*3].nodeSize}get textOffset(){return this.pos-this.path[this.path.length-1]}get nodeAfter(){let e=this.parent,t=this.index(this.depth);if(t==e.childCount)return null;let n=this.pos-this.path[this.path.length-1],r=e.child(t);return n?e.child(t).cut(n):r}get nodeBefore(){let e=this.index(this.depth),t=this.pos-this.path[this.path.length-1];return t?this.parent.child(e).cut(0,t):e==0?null:this.parent.child(e-1)}posAtIndex(e,t){t=this.resolveDepth(t);let n=this.path[t*3],r=t==0?0:this.path[t*3-1]+1;for(let s=0;s<e;s++)r+=n.child(s).nodeSize;return r}marks(){let e=this.parent,t=this.index();if(e.content.size==0)return S.none;if(this.textOffset)return e.child(t).marks;let n=e.maybeChild(t-1),r=e.maybeChild(t);if(!n){let o=n;n=r,r=o}let s=n.marks;for(var l=0;l<s.length;l++)s[l].type.spec.inclusive===!1&&(!r||!s[l].isInSet(r.marks))&&(s=s[l--].removeFromSet(s));return s}marksAcross(e){let t=this.parent.maybeChild(this.index());if(!t||!t.isInline)return null;let n=t.marks,r=e.parent.maybeChild(e.index());for(var s=0;s<n.length;s++)n[s].type.spec.inclusive===!1&&(!r||!n[s].isInSet(r.marks))&&(n=n[s--].removeFromSet(n));return n}sharedDepth(e){for(let t=this.depth;t>0;t--)if(this.start(t)<=e&&this.end(t)>=e)return t;return 0}blockRange(e=this,t){if(e.pos<this.pos)return e.blockRange(this);for(let n=this.depth-(this.parent.inlineContent||this.pos==e.pos?1:0);n>=0;n--)if(e.pos<=this.end(n)&&(!t||t(this.node(n))))return new oe(this,e,n);return null}sameParent(e){return this.pos-this.parentOffset==e.pos-e.parentOffset}max(e){return e.pos>this.pos?e:this}min(e){return e.pos<this.pos?e:this}toString(){let e="";for(let t=1;t<=this.depth;t++)e+=(e?"/":"")+this.node(t).type.name+"_"+this.index(t-1);return e+":"+this.parentOffset}static resolve(e,t){if(!(t>=0&&t<=e.content.size))throw new RangeError("Position "+t+" out of range");let n=[],r=0,s=t;for(let l=e;;){let{index:o,offset:a}=l.content.findIndex(s),h=s-a;if(n.push(l,o,r+a),!h||(l=l.child(o),l.isText))break;s=h-1,r+=a+1}return new i(t,n,s)}static resolveCached(e,t){let n=Ee.get(e);if(n)for(let s=0;s<n.elts.length;s++){let l=n.elts[s];if(l.pos==t)return l}else Ee.set(e,n=new le);let r=n.elts[n.i]=i.resolve(e,t);return n.i=(n.i+1)%at,r}},le=class{constructor(){this.elts=[],this.i=0}},at=12,Ee=new WeakMap,oe=class{constructor(e,t,n){this.$from=e,this.$to=t,this.depth=n}get start(){return this.$from.before(this.depth+1)}get end(){return this.$to.after(this.depth+1)}get parent(){return this.$from.node(this.depth)}get startIndex(){return this.$from.index(this.depth)}get endIndex(){return this.$to.indexAfter(this.depth)}},ht=Object.create(null),P=class i{constructor(e,t,n,r=S.none){this.type=e,this.attrs=t,this.marks=r,this.content=n||m.empty}get children(){return this.content.content}get nodeSize(){return this.isLeaf?1:2+this.content.size}get childCount(){return this.content.childCount}child(e){return this.content.child(e)}maybeChild(e){return this.content.maybeChild(e)}forEach(e){this.content.forEach(e)}nodesBetween(e,t,n,r=0){this.content.nodesBetween(e,t,n,r,this)}descendants(e){this.nodesBetween(0,this.content.size,e)}get textContent(){return this.isLeaf&&this.type.spec.leafText?this.type.spec.leafText(this):this.textBetween(0,this.content.size,"")}textBetween(e,t,n,r){return this.content.textBetween(e,t,n,r)}get firstChild(){return this.content.firstChild}get lastChild(){return this.content.lastChild}eq(e){return this==e||this.sameMarkup(e)&&this.content.eq(e.content)}sameMarkup(e){return this.hasMarkup(e.type,e.attrs,e.marks)}hasMarkup(e,t,n){return this.type==e&&X(this.attrs,t||e.defaultAttrs||ht)&&S.sameSet(this.marks,n||S.none)}copy(e=null){return e==this.content?this:new i(this.type,this.attrs,e,this.marks)}mark(e){return e==this.marks?this:new i(this.type,this.attrs,this.content,e)}cut(e,t=this.content.size){return e==0&&t==this.content.size?this:this.copy(this.content.cut(e,t))}slice(e,t=this.content.size,n=!1){if(e==t)return u.empty;let r=this.resolve(e),s=this.resolve(t),l=n?0:r.sharedDepth(t),o=r.start(l),h=r.node(l).content.cut(r.pos-o,s.pos-o);return new u(h,r.depth-l,s.depth-l)}replace(e,t,n){return lt(this.resolve(e),this.resolve(t),n)}nodeAt(e){for(let t=this;;){let{index:n,offset:r}=t.content.findIndex(e);if(t=t.maybeChild(n),!t)return null;if(r==e||t.isText)return t;e-=r+1}}childAfter(e){let{index:t,offset:n}=this.content.findIndex(e);return{node:this.content.maybeChild(t),index:t,offset:n}}childBefore(e){if(e==0)return{node:null,index:0,offset:0};let{index:t,offset:n}=this.content.findIndex(e);if(n<e)return{node:this.content.child(t),index:t,offset:n};let r=this.content.child(t-1);return{node:r,index:t-1,offset:n-r.nodeSize}}resolve(e){return Z.resolveCached(this,e)}resolveNoCache(e){return Z.resolve(this,e)}rangeHasMark(e,t,n){let r=!1;return t>e&&this.nodesBetween(e,t,s=>(n.isInSet(s.marks)&&(r=!0),!r)),r}get isBlock(){return this.type.isBlock}get isTextblock(){return this.type.isTextblock}get inlineContent(){return this.type.inlineContent}get isInline(){return this.type.isInline}get isText(){return this.type.isText}get isLeaf(){return this.type.isLeaf}get isAtom(){return this.type.isAtom}toString(){if(this.type.spec.toDebugString)return this.type.spec.toDebugString(this);let e=this.type.name;return this.content.size&&(e+="("+this.content.toStringInner()+")"),ct(this.marks,e)}contentMatchAt(e){let t=this.type.contentMatch.matchFragment(this.content,0,e);if(!t)throw new Error("Called contentMatchAt on a node with invalid content");return t}canReplace(e,t,n=m.empty,r=0,s=n.childCount){let l=this.contentMatchAt(e).matchFragment(n,r,s),o=l&&l.matchFragment(this.content,t);if(!o||!o.validEnd)return!1;for(let a=r;a<s;a++)if(!this.type.allowsMarks(n.child(a).marks))return!1;return!0}canReplaceWith(e,t,n,r){if(r&&!this.type.allowsMarks(r))return!1;let s=this.contentMatchAt(e).matchType(n),l=s&&s.matchFragment(this.content,t);return l?l.validEnd:!1}canAppend(e){return e.content.size?this.canReplace(this.childCount,this.childCount,e.content):this.type.compatibleContent(e.type)}check(){this.type.checkContent(this.content),this.type.checkAttrs(this.attrs);let e=S.none;for(let t=0;t<this.marks.length;t++){let n=this.marks[t];n.type.checkAttrs(n.attrs),e=n.addToSet(e)}if(!S.sameSet(e,this.marks))throw new RangeError(`Invalid collection of marks for node ${this.type.name}: ${this.marks.map(t=>t.type.name)}`);this.content.forEach(t=>t.check())}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return this.content.size&&(e.content=this.content.toJSON()),this.marks.length&&(e.marks=this.marks.map(t=>t.toJSON())),e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Node.fromJSON");let n;if(t.marks){if(!Array.isArray(t.marks))throw new RangeError("Invalid mark data for Node.fromJSON");n=t.marks.map(e.markFromJSON)}if(t.type=="text"){if(typeof t.text!="string")throw new RangeError("Invalid text node in JSON");return e.text(t.text,n)}let r=m.fromJSON(e,t.content),s=e.nodeType(t.type).create(t.attrs,r,n);return s.type.checkAttrs(s.attrs),s}};P.prototype.text=void 0;function ct(i,e){for(let t=i.length-1;t>=0;t--)e=i[t].type.name+"("+e+")";return e}var L=class i{constructor(e){this.validEnd=e,this.next=[],this.wrapCache=[]}static parse(e,t){let n=new ae(e,t);if(n.next==null)return i.empty;let r=Fe(n);n.next&&n.err("Unexpected trailing text");let s=yt(gt(r));return wt(s,n),s}matchType(e){for(let t=0;t<this.next.length;t++)if(this.next[t].type==e)return this.next[t].next;return null}matchFragment(e,t=0,n=e.childCount){let r=this;for(let s=t;r&&s<n;s++)r=r.matchType(e.child(s).type);return r}get inlineContent(){return this.next.length!=0&&this.next[0].type.isInline}get defaultType(){for(let e=0;e<this.next.length;e++){let{type:t}=this.next[e];if(!(t.isText||t.hasRequiredAttrs()))return t}return null}compatible(e){for(let t=0;t<this.next.length;t++)for(let n=0;n<e.next.length;n++)if(this.next[t].type==e.next[n].type)return!0;return!1}fillBefore(e,t=!1,n=0){let r=[this];function s(l,o){let a=l.matchFragment(e,n);if(a&&(!t||a.validEnd))return m.from(o.map(h=>h.createAndFill()));for(let h=0;h<l.next.length;h++){let{type:c,next:p}=l.next[h];if(!(c.isText||c.hasRequiredAttrs())&&r.indexOf(p)==-1){r.push(p);let f=s(p,o.concat(c));if(f)return f}}return null}return s(this,[])}findWrapping(e){for(let n=0;n<this.wrapCache.length;n+=2)if(this.wrapCache[n]==e)return this.wrapCache[n+1];let t=this.computeWrapping(e);return this.wrapCache.push(e,t),t}computeWrapping(e){let t=Object.create(null),n=[{match:this,type:null,via:null}];for(;n.length;){let r=n.shift(),s=r.match;if(s.matchType(e)){let l=[];for(let o=r;o.type;o=o.via)l.push(o.type);return l.reverse()}for(let l=0;l<s.next.length;l++){let{type:o,next:a}=s.next[l];!o.isLeaf&&!o.hasRequiredAttrs()&&!(o.name in t)&&(!r.type||a.validEnd)&&(n.push({match:o.contentMatch,type:o,via:r}),t[o.name]=!0)}}return null}get edgeCount(){return this.next.length}edge(e){if(e>=this.next.length)throw new RangeError(`There's no ${e}th edge in this content match`);return this.next[e]}toString(){let e=[];function t(n){e.push(n);for(let r=0;r<n.next.length;r++)e.indexOf(n.next[r].next)==-1&&t(n.next[r].next)}return t(this),e.map((n,r)=>{let s=r+(n.validEnd?"*":" ")+" ";for(let l=0;l<n.next.length;l++)s+=(l?", ":"")+n.next[l].type.name+"->"+e.indexOf(n.next[l].next);return s}).join(`
`)}};L.empty=new L(!0);var ae=class{constructor(e,t){this.string=e,this.nodeTypes=t,this.inline=null,this.pos=0,this.tokens=e.split(/\s*(?=\b|\W|$)/),this.tokens[this.tokens.length-1]==""&&this.tokens.pop(),this.tokens[0]==""&&this.tokens.shift()}get next(){return this.tokens[this.pos]}eat(e){return this.next==e&&(this.pos++||!0)}err(e){throw new SyntaxError(e+" (in content expression '"+this.string+"')")}};function Fe(i){let e=[];do e.push(ft(i));while(i.eat("|"));return e.length==1?e[0]:{type:"choice",exprs:e}}function ft(i){let e=[];do e.push(ut(i));while(i.next&&i.next!=")"&&i.next!="|");return e.length==1?e[0]:{type:"seq",exprs:e}}function ut(i){let e=mt(i);for(;;)if(i.eat("+"))e={type:"plus",expr:e};else if(i.eat("*"))e={type:"star",expr:e};else if(i.eat("?"))e={type:"opt",expr:e};else if(i.eat("{"))e=pt(i,e);else break;return e}function be(i){/\D/.test(i.next)&&i.err("Expected number, got '"+i.next+"'");let e=Number(i.next);return i.pos++,e}function pt(i,e){let t=be(i),n=t;return i.eat(",")&&(i.next!="}"?n=be(i):n=-1),i.eat("}")||i.err("Unclosed braced range"),{type:"range",min:t,max:n,expr:e}}function dt(i,e){let t=i.nodeTypes,n=t[e];if(n)return[n];let r=[];for(let s in t){let l=t[s];l.isInGroup(e)&&r.push(l)}return r.length==0&&i.err("No node type or group '"+e+"' found"),r}function mt(i){if(i.eat("(")){let e=Fe(i);return i.eat(")")||i.err("Missing closing paren"),e}else if(/\W/.test(i.next))i.err("Unexpected token '"+i.next+"'");else{let e=dt(i,i.next).map(t=>(i.inline==null?i.inline=t.isInline:i.inline!=t.isInline&&i.err("Mixing inline and block content"),{type:"name",value:t}));return i.pos++,e.length==1?e[0]:{type:"choice",exprs:e}}}function gt(i){let e=[[]];return r(s(i,0),t()),e;function t(){return e.push([])-1}function n(l,o,a){let h={term:a,to:o};return e[l].push(h),h}function r(l,o){l.forEach(a=>a.to=o)}function s(l,o){if(l.type=="choice")return l.exprs.reduce((a,h)=>a.concat(s(h,o)),[]);if(l.type=="seq")for(let a=0;;a++){let h=s(l.exprs[a],o);if(a==l.exprs.length-1)return h;r(h,o=t())}else if(l.type=="star"){let a=t();return n(o,a),r(s(l.expr,a),a),[n(a)]}else if(l.type=="plus"){let a=t();return r(s(l.expr,o),a),r(s(l.expr,a),a),[n(a)]}else{if(l.type=="opt")return[n(o)].concat(s(l.expr,o));if(l.type=="range"){let a=o;for(let h=0;h<l.min;h++){let c=t();r(s(l.expr,a),c),a=c}if(l.max==-1)r(s(l.expr,a),a);else for(let h=l.min;h<l.max;h++){let c=t();n(a,c),r(s(l.expr,a),c),a=c}return[n(a)]}else{if(l.type=="name")return[n(o,void 0,l.value)];throw new Error("Unknown expr type")}}}}function Je(i,e){return e-i}function Oe(i,e){let t=[];return n(e),t.sort(Je);function n(r){let s=i[r];if(s.length==1&&!s[0].term)return n(s[0].to);t.push(r);for(let l=0;l<s.length;l++){let{term:o,to:a}=s[l];!o&&t.indexOf(a)==-1&&n(a)}}}function yt(i){let e=Object.create(null);return t(Oe(i,0));function t(n){let r=[];n.forEach(l=>{i[l].forEach(({term:o,to:a})=>{if(!o)return;let h;for(let c=0;c<r.length;c++)r[c][0]==o&&(h=r[c][1]);Oe(i,a).forEach(c=>{h||r.push([o,h=[]]),h.indexOf(c)==-1&&h.push(c)})})});let s=e[n.join(",")]=new L(n.indexOf(i.length-1)>-1);for(let l=0;l<r.length;l++){let o=r[l][1].sort(Je);s.next.push({type:r[l][0],next:e[o.join(",")]||t(o)})}return s}}function wt(i,e){for(let t=0,n=[i];t<n.length;t++){let r=n[t],s=!r.validEnd,l=[];for(let o=0;o<r.next.length;o++){let{type:a,next:h}=r.next[o];l.push(a.name),s&&!(a.isText||a.hasRequiredAttrs())&&(s=!1),n.indexOf(h)==-1&&n.push(h)}s&&e.err("Only non-generatable nodes ("+l.join(", ")+") in a required position (see https://prosemirror.net/docs/guide/#generatable)")}}function xt(i){let e=Object.create(null);for(let t in i){let n=i[t];if(!n.hasDefault)return null;e[t]=n.default}return e}function kt(i,e){let t=Object.create(null);for(let n in i){let r=e&&e[n];if(r===void 0){let s=i[n];if(s.hasDefault)r=s.default;else throw new RangeError("No value supplied for attribute "+n)}t[n]=r}return t}function St(i,e,t,n){for(let r in e)if(!(r in i))throw new RangeError(`Unsupported attribute ${r} for ${t} of type ${r}`);for(let r in i){let s=i[r];s.validate&&s.validate(e[r])}}function vt(i,e){let t=Object.create(null);if(e)for(let n in e)t[n]=new he(i,n,e[n]);return t}function Mt(i,e,t){let n=t.split("|");return r=>{let s=r===null?"null":typeof r;if(n.indexOf(s)<0)throw new RangeError(`Expected value of type ${n} for attribute ${e} on type ${i}, got ${s}`)}}var he=class{constructor(e,t,n){this.hasDefault=Object.prototype.hasOwnProperty.call(n,"default"),this.default=n.default,this.validate=typeof n.validate=="string"?Mt(e,t,n.validate):n.validate}get isRequired(){return!this.hasDefault}},j=class i{constructor(e,t,n,r){this.name=e,this.rank=t,this.schema=n,this.spec=r,this.attrs=vt(e,r.attrs),this.excluded=null;let s=xt(this.attrs);this.instance=s?new S(this,s):null}create(e=null){return!e&&this.instance?this.instance:new S(this,kt(this.attrs,e))}static compile(e,t){let n=Object.create(null),r=0;return e.forEach((s,l)=>n[s]=new i(s,r++,t,l)),n}removeFromSet(e){for(var t=0;t<e.length;t++)e[t].type==this&&(e=e.slice(0,t).concat(e.slice(t+1)),t--);return e}isInSet(e){for(let t=0;t<e.length;t++)if(e[t].type==this)return e[t]}checkAttrs(e){St(this.attrs,e,"mark",this.name)}excludes(e){return this.excluded.indexOf(e)>-1}};var Be=65535,We=Math.pow(2,16);function Et(i,e){return i+e*We}function De(i){return i&Be}function bt(i){return(i-(i&Be))/We}var Pe=1,Le=2,$=4,qe=8,V=class{constructor(e,t,n){this.pos=e,this.delInfo=t,this.recover=n}get deleted(){return(this.delInfo&qe)>0}get deletedBefore(){return(this.delInfo&(Pe|$))>0}get deletedAfter(){return(this.delInfo&(Le|$))>0}get deletedAcross(){return(this.delInfo&$)>0}},b=class i{constructor(e,t=!1){if(this.ranges=e,this.inverted=t,!e.length&&i.empty)return i.empty}recover(e){let t=0,n=De(e);if(!this.inverted)for(let r=0;r<n;r++)t+=this.ranges[r*3+2]-this.ranges[r*3+1];return this.ranges[n*3]+t+bt(e)}mapResult(e,t=1){return this._map(e,t,!1)}map(e,t=1){return this._map(e,t,!0)}_map(e,t,n){let r=0,s=this.inverted?2:1,l=this.inverted?1:2;for(let o=0;o<this.ranges.length;o+=3){let a=this.ranges[o]-(this.inverted?r:0);if(a>e)break;let h=this.ranges[o+s],c=this.ranges[o+l],p=a+h;if(e<=p){let f=h?e==a?-1:e==p?1:t:t,d=a+r+(f<0?0:c);if(n)return d;let g=e==(t<0?a:p)?null:Et(o/3,e-a),y=e==a?Le:e==p?Pe:$;return(t<0?e!=a:e!=p)&&(y|=qe),new V(d,y,g)}r+=c-h}return n?e+r:new V(e+r,0,null)}touches(e,t){let n=0,r=De(t),s=this.inverted?2:1,l=this.inverted?1:2;for(let o=0;o<this.ranges.length;o+=3){let a=this.ranges[o]-(this.inverted?n:0);if(a>e)break;let h=this.ranges[o+s],c=a+h;if(e<=c&&o==r*3)return!0;n+=this.ranges[o+l]-h}return!1}forEach(e){let t=this.inverted?2:1,n=this.inverted?1:2;for(let r=0,s=0;r<this.ranges.length;r+=3){let l=this.ranges[r],o=l-(this.inverted?s:0),a=l+(this.inverted?0:s),h=this.ranges[r+t],c=this.ranges[r+n];e(o,o+h,a,a+c),s+=c-h}}invert(){return new i(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(e){return e==0?i.empty:new i(e<0?[0,-e,0]:[0,0,e])}};b.empty=new b([]);var pe=class i{constructor(e,t,n=0,r=e?e.length:0){this.mirror=t,this.from=n,this.to=r,this._maps=e||[],this.ownData=!(e||t)}get maps(){return this._maps}slice(e=0,t=this.maps.length){return new i(this._maps,this.mirror,e,t)}appendMap(e,t){this.ownData||(this._maps=this._maps.slice(),this.mirror=this.mirror&&this.mirror.slice(),this.ownData=!0),this.to=this._maps.push(e),t!=null&&this.setMirror(this._maps.length-1,t)}appendMapping(e){for(let t=0,n=this._maps.length;t<e._maps.length;t++){let r=e.getMirror(t);this.appendMap(e._maps[t],r!=null&&r<t?n+r:void 0)}}getMirror(e){if(this.mirror){for(let t=0;t<this.mirror.length;t++)if(this.mirror[t]==e)return this.mirror[t+(t%2?-1:1)]}}setMirror(e,t){this.mirror||(this.mirror=[]),this.mirror.push(e,t)}appendMappingInverted(e){for(let t=e.maps.length-1,n=this._maps.length+e._maps.length;t>=0;t--){let r=e.getMirror(t);this.appendMap(e._maps[t].invert(),r!=null&&r>t?n-r-1:void 0)}}invert(){let e=new i;return e.appendMappingInverted(this),e}map(e,t=1){if(this.mirror)return this._map(e,t,!0);for(let n=this.from;n<this.to;n++)e=this._maps[n].map(e,t);return e}mapResult(e,t=1){return this._map(e,t,!1)}_map(e,t,n){let r=0;for(let s=this.from;s<this.to;s++){let l=this._maps[s],o=l.mapResult(e,t);if(o.recover!=null){let a=this.getMirror(s);if(a!=null&&a>s&&a<this.to){s=a,e=this._maps[a].recover(o.recover);continue}}r|=o.delInfo,e=o.pos}return n?e:new V(e,r,null)}},ce=Object.create(null),x=class{getMap(){return b.empty}merge(e){return null}static fromJSON(e,t){if(!t||!t.stepType)throw new RangeError("Invalid input for Step.fromJSON");let n=ce[t.stepType];if(!n)throw new RangeError(`No step type ${t.stepType} defined`);return n.fromJSON(e,t)}static jsonID(e,t){if(e in ce)throw new RangeError("Duplicate use of step JSON ID "+e);return ce[e]=t,t.prototype.jsonID=e,t}},k=class i{constructor(e,t){this.doc=e,this.failed=t}static ok(e){return new i(e,null)}static fail(e){return new i(null,e)}static fromReplace(e,t,n,r){try{return i.ok(e.replace(t,n,r))}catch(s){if(s instanceof R)return i.fail(s.message);throw s}}};function ge(i,e,t){let n=[];for(let r=0;r<i.childCount;r++){let s=i.child(r);s.content.size&&(s=s.copy(ge(s.content,e,s))),s.isInline&&(s=e(s,t,r)),n.push(s)}return m.fromArray(n)}var G=class i extends x{constructor(e,t,n){super(),this.from=e,this.to=t,this.mark=n}apply(e){let t=e.slice(this.from,this.to),n=e.resolve(this.from),r=n.node(n.sharedDepth(this.to)),s=new u(ge(t.content,(l,o)=>!l.isAtom||!o.type.allowsMarkType(this.mark.type)?l:l.mark(this.mark.addToSet(l.marks)),r),t.openStart,t.openEnd);return k.fromReplace(e,this.from,this.to,s)}invert(){return new I(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deleted&&n.deleted||t.pos>=n.pos?null:new i(t.pos,n.pos,this.mark)}merge(e){return e instanceof i&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new i(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new i(t.from,t.to,e.markFromJSON(t.mark))}};x.jsonID("addMark",G);var I=class i extends x{constructor(e,t,n){super(),this.from=e,this.to=t,this.mark=n}apply(e){let t=e.slice(this.from,this.to),n=new u(ge(t.content,r=>r.mark(this.mark.removeFromSet(r.marks)),e),t.openStart,t.openEnd);return k.fromReplace(e,this.from,this.to,n)}invert(){return new G(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deleted&&n.deleted||t.pos>=n.pos?null:new i(t.pos,n.pos,this.mark)}merge(e){return e instanceof i&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new i(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new i(t.from,t.to,e.markFromJSON(t.mark))}};x.jsonID("removeMark",I);var K=class i extends x{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return k.fail("No node at mark step's position");let n=t.type.create(t.attrs,null,this.mark.addToSet(t.marks));return k.fromReplace(e,this.pos,this.pos+1,new u(m.from(n),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);if(t){let n=this.mark.addToSet(t.marks);if(n.length==t.marks.length){for(let r=0;r<t.marks.length;r++)if(!t.marks[r].isInSet(n))return new i(this.pos,t.marks[r]);return new i(this.pos,this.mark)}}return new J(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new i(t.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new i(t.pos,e.markFromJSON(t.mark))}};x.jsonID("addNodeMark",K);var J=class i extends x{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return k.fail("No node at mark step's position");let n=t.type.create(t.attrs,null,this.mark.removeFromSet(t.marks));return k.fromReplace(e,this.pos,this.pos+1,new u(m.from(n),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);return!t||!this.mark.isInSet(t.marks)?this:new K(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new i(t.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new i(t.pos,e.markFromJSON(t.mark))}};x.jsonID("removeNodeMark",J);var M=class i extends x{constructor(e,t,n,r=!1){super(),this.from=e,this.to=t,this.slice=n,this.structure=r}apply(e){return this.structure&&de(e,this.from,this.to)?k.fail("Structure replace would overwrite content"):k.fromReplace(e,this.from,this.to,this.slice)}getMap(){return new b([this.from,this.to-this.from,this.slice.size])}invert(e){return new i(this.from,this.from+this.slice.size,e.slice(this.from,this.to))}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deletedAcross&&n.deletedAcross?null:new i(t.pos,Math.max(t.pos,n.pos),this.slice,this.structure)}merge(e){if(!(e instanceof i)||e.structure||this.structure)return null;if(this.from+this.slice.size==e.from&&!this.slice.openEnd&&!e.slice.openStart){let t=this.slice.size+e.slice.size==0?u.empty:new u(this.slice.content.append(e.slice.content),this.slice.openStart,e.slice.openEnd);return new i(this.from,this.to+(e.to-e.from),t,this.structure)}else if(e.to==this.from&&!this.slice.openStart&&!e.slice.openEnd){let t=this.slice.size+e.slice.size==0?u.empty:new u(e.slice.content.append(this.slice.content),e.slice.openStart,this.slice.openEnd);return new i(e.from,this.to,t,this.structure)}else return null}toJSON(){let e={stepType:"replace",from:this.from,to:this.to};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new i(t.from,t.to,u.fromJSON(e,t.slice),!!t.structure)}};x.jsonID("replace",M);var E=class i extends x{constructor(e,t,n,r,s,l,o=!1){super(),this.from=e,this.to=t,this.gapFrom=n,this.gapTo=r,this.slice=s,this.insert=l,this.structure=o}apply(e){if(this.structure&&(de(e,this.from,this.gapFrom)||de(e,this.gapTo,this.to)))return k.fail("Structure gap-replace would overwrite content");let t=e.slice(this.gapFrom,this.gapTo);if(t.openStart||t.openEnd)return k.fail("Gap is not a flat range");let n=this.slice.insertAt(this.insert,t.content);return n?k.fromReplace(e,this.from,this.to,n):k.fail("Content does not fit in gap")}getMap(){return new b([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(e){let t=this.gapTo-this.gapFrom;return new i(this.from,this.from+this.slice.size+t,this.from+this.insert,this.from+this.insert+t,e.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1),r=this.from==this.gapFrom?t.pos:e.map(this.gapFrom,-1),s=this.to==this.gapTo?n.pos:e.map(this.gapTo,1);return t.deletedAcross&&n.deletedAcross||r<t.pos||s>n.pos?null:new i(t.pos,n.pos,r,s,this.slice,this.insert,this.structure)}toJSON(){let e={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number"||typeof t.gapFrom!="number"||typeof t.gapTo!="number"||typeof t.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new i(t.from,t.to,t.gapFrom,t.gapTo,u.fromJSON(e,t.slice),t.insert,!!t.structure)}};x.jsonID("replaceAround",E);function de(i,e,t){let n=i.resolve(e),r=t-e,s=n.depth;for(;r>0&&s>0&&n.indexAfter(s)==n.node(s).childCount;)s--,r--;if(r>0){let l=n.node(s).maybeChild(n.indexAfter(s));for(;r>0;){if(!l||l.isLeaf)return!0;l=l.firstChild,r--}}return!1}function Ot(i,e,t,n){let r=[],s=[],l,o;i.doc.nodesBetween(e,t,(a,h,c)=>{if(!a.isInline)return;let p=a.marks;if(!n.isInSet(p)&&c.type.allowsMarkType(n.type)){let f=Math.max(h,e),d=Math.min(h+a.nodeSize,t),g=n.addToSet(p);for(let y=0;y<p.length;y++)p[y].isInSet(g)||(l&&l.to==f&&l.mark.eq(p[y])?l.to=d:r.push(l=new I(f,d,p[y])));o&&o.to==f?o.to=d:s.push(o=new G(f,d,n))}}),r.forEach(a=>i.step(a)),s.forEach(a=>i.step(a))}function Ct(i,e,t,n){let r=[],s=0;i.doc.nodesBetween(e,t,(l,o)=>{if(!l.isInline)return;s++;let a=null;if(n instanceof j){let h=l.marks,c;for(;c=n.isInSet(h);)(a||(a=[])).push(c),h=c.removeFromSet(h)}else n?n.isInSet(l.marks)&&(a=[n]):a=l.marks;if(a&&a.length){let h=Math.min(o+l.nodeSize,t);for(let c=0;c<a.length;c++){let p=a[c],f;for(let d=0;d<r.length;d++){let g=r[d];g.step==s-1&&p.eq(r[d].style)&&(f=g)}f?(f.to=h,f.step=s):r.push({style:p,from:Math.max(o,e),to:h,step:s})}}}),r.forEach(l=>i.step(new I(l.from,l.to,l.style)))}function ye(i,e,t,n=t.contentMatch,r=!0){let s=i.doc.nodeAt(e),l=[],o=e+1;for(let a=0;a<s.childCount;a++){let h=s.child(a),c=o+h.nodeSize,p=n.matchType(h.type);if(!p)l.push(new M(o,c,u.empty));else{n=p;for(let f=0;f<h.marks.length;f++)t.allowsMarkType(h.marks[f].type)||i.step(new I(o,c,h.marks[f]));if(r&&h.isText&&t.whitespace!="pre"){let f,d=/\r?\n|\r/g,g;for(;f=d.exec(h.text);)g||(g=new u(m.from(t.schema.text(" ",t.allowedMarks(h.marks))),0,0)),l.push(new M(o+f.index,o+f.index+f[0].length,g))}}o=c}if(!n.validEnd){let a=n.fillBefore(m.empty,!0);i.replace(o,o,new u(a,0,0))}for(let a=l.length-1;a>=0;a--)i.step(l[a])}function Tt(i,e,t){let{$from:n,$to:r,depth:s}=e,l=n.before(s+1),o=r.after(s+1),a=l,h=o,c=m.empty,p=0;for(let g=s,y=!1;g>t;g--)y||n.index(g)>0?(y=!0,c=m.from(n.node(g).copy(c)),p++):a--;let f=m.empty,d=0;for(let g=s,y=!1;g>t;g--)y||r.after(g+1)<r.end(g)?(y=!0,f=m.from(r.node(g).copy(f)),d++):h++;i.step(new E(a,h,l,o,new u(c.append(f),p,d),c.size-p,!0))}function Nt(i,e,t){let n=m.empty;for(let l=t.length-1;l>=0;l--){if(n.size){let o=t[l].type.contentMatch.matchFragment(n);if(!o||!o.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}n=m.from(t[l].type.create(t[l].attrs,n))}let r=e.start,s=e.end;i.step(new E(r,s,r,s,new u(n,0,0),t.length,!0))}function Rt(i,e,t,n,r){if(!n.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");let s=i.steps.length;i.doc.nodesBetween(e,t,(l,o)=>{let a=typeof r=="function"?r(l):r;if(l.isTextblock&&!l.hasMarkup(n,a)&&It(i.doc,i.mapping.slice(s).map(o),n)){let h=null;if(n.schema.linebreakReplacement){let d=n.whitespace=="pre",g=!!n.contentMatch.matchType(n.schema.linebreakReplacement);d&&!g?h=!1:!d&&g&&(h=!0)}h===!1&&Ve(i,l,o,s),ye(i,i.mapping.slice(s).map(o,1),n,void 0,h===null);let c=i.mapping.slice(s),p=c.map(o,1),f=c.map(o+l.nodeSize,1);return i.step(new E(p,f,p+1,f-1,new u(m.from(n.create(a,null,l.marks)),0,0),1,!0)),h===!0&&Ue(i,l,o,s),!1}})}function Ue(i,e,t,n){e.forEach((r,s)=>{if(r.isText){let l,o=/\r?\n|\r/g;for(;l=o.exec(r.text);){let a=i.mapping.slice(n).map(t+1+s+l.index);i.replaceWith(a,a+1,e.type.schema.linebreakReplacement.create())}}})}function Ve(i,e,t,n){e.forEach((r,s)=>{if(r.type==r.type.schema.linebreakReplacement){let l=i.mapping.slice(n).map(t+1+s);i.replaceWith(l,l+1,e.type.schema.text(`
`))}})}function It(i,e,t){let n=i.resolve(e),r=n.index();return n.parent.canReplaceWith(r,r+1,t)}function At(i,e,t,n,r){let s=i.doc.nodeAt(e);if(!s)throw new RangeError("No node at given position");t||(t=s.type);let l=t.create(n,null,r||s.marks);if(s.isLeaf)return i.replaceWith(e,e+s.nodeSize,l);if(!t.validContent(s.content))throw new RangeError("Invalid content for node type "+t.name);i.step(new E(e,e+s.nodeSize,e+1,e+s.nodeSize-1,new u(m.from(l),0,0),1,!0))}function zt(i,e,t=1,n){let r=i.doc.resolve(e),s=m.empty,l=m.empty;for(let o=r.depth,a=r.depth-t,h=t-1;o>a;o--,h--){s=m.from(r.node(o).copy(s));let c=n&&n[h];l=m.from(c?c.type.create(c.attrs,l):r.node(o).copy(l))}i.step(new M(e,e,new u(s.append(l),t,t),!0))}function Ft(i,e,t){let n=null,{linebreakReplacement:r}=i.doc.type.schema,s=i.doc.resolve(e-t),l=s.node().type;if(r&&l.inlineContent){let c=l.whitespace=="pre",p=!!l.contentMatch.matchType(r);c&&!p?n=!1:!c&&p&&(n=!0)}let o=i.steps.length;if(n===!1){let c=i.doc.resolve(e+t);Ve(i,c.node(),c.before(),o)}l.inlineContent&&ye(i,e+t-1,l,s.node().contentMatchAt(s.index()),n==null);let a=i.mapping.slice(o),h=a.map(e-t);if(i.step(new M(h,a.map(e+t,-1),u.empty,!0)),n===!0){let c=i.doc.resolve(h);Ue(i,c.node(),c.before(),i.steps.length)}return i}function Jt(i,e,t){let n=i.resolve(e);if(n.parent.canReplaceWith(n.index(),n.index(),t))return e;if(n.parentOffset==0)for(let r=n.depth-1;r>=0;r--){let s=n.index(r);if(n.node(r).canReplaceWith(s,s,t))return n.before(r+1);if(s>0)return null}if(n.parentOffset==n.parent.content.size)for(let r=n.depth-1;r>=0;r--){let s=n.indexAfter(r);if(n.node(r).canReplaceWith(s,s,t))return n.after(r+1);if(s<n.node(r).childCount)return null}return null}function Dt(i,e,t=e,n=u.empty){if(e==t&&!n.size)return null;let r=i.resolve(e),s=i.resolve(t);return Ge(r,s,n)?new M(e,t,n):new me(r,s,n).fit()}function Ge(i,e,t){return!t.openStart&&!t.openEnd&&i.start()==e.start()&&i.parent.canReplace(i.index(),e.index(),t.content)}var me=class{constructor(e,t,n){this.$from=e,this.$to=t,this.unplaced=n,this.frontier=[],this.placed=m.empty;for(let r=0;r<=e.depth;r++){let s=e.node(r);this.frontier.push({type:s.type,match:s.contentMatchAt(e.indexAfter(r))})}for(let r=e.depth;r>0;r--)this.placed=m.from(e.node(r).copy(this.placed))}get depth(){return this.frontier.length-1}fit(){for(;this.unplaced.size;){let h=this.findFittable();h?this.placeNodes(h):this.openMore()||this.dropNode()}let e=this.mustMoveInline(),t=this.placed.size-this.depth-this.$from.depth,n=this.$from,r=this.close(e<0?this.$to:n.doc.resolve(e));if(!r)return null;let s=this.placed,l=n.depth,o=r.depth;for(;l&&o&&s.childCount==1;)s=s.firstChild.content,l--,o--;let a=new u(s,l,o);return e>-1?new E(n.pos,e,this.$to.pos,this.$to.end(),a,t):a.size||n.pos!=this.$to.pos?new M(n.pos,r.pos,a):null}findFittable(){let e=this.unplaced.openStart;for(let t=this.unplaced.content,n=0,r=this.unplaced.openEnd;n<e;n++){let s=t.firstChild;if(t.childCount>1&&(r=0),s.type.spec.isolating&&r<=n){e=n;break}t=s.content}for(let t=1;t<=2;t++)for(let n=t==1?e:this.unplaced.openStart;n>=0;n--){let r,s=null;n?(s=fe(this.unplaced.content,n-1).firstChild,r=s.content):r=this.unplaced.content;let l=r.firstChild;for(let o=this.depth;o>=0;o--){let{type:a,match:h}=this.frontier[o],c,p=null;if(t==1&&(l?h.matchType(l.type)||(p=h.fillBefore(m.from(l),!1)):s&&a.compatibleContent(s.type)))return{sliceDepth:n,frontierDepth:o,parent:s,inject:p};if(t==2&&l&&(c=h.findWrapping(l.type)))return{sliceDepth:n,frontierDepth:o,parent:s,wrap:c};if(s&&h.matchType(s.type))break}}}openMore(){let{content:e,openStart:t,openEnd:n}=this.unplaced,r=fe(e,t);return!r.childCount||r.firstChild.isLeaf?!1:(this.unplaced=new u(e,t+1,Math.max(n,r.size+t>=e.size-n?t+1:0)),!0)}dropNode(){let{content:e,openStart:t,openEnd:n}=this.unplaced,r=fe(e,t);if(r.childCount<=1&&t>0){let s=e.size-t<=t+r.size;this.unplaced=new u(q(e,t-1,1),t-1,s?t-1:n)}else this.unplaced=new u(q(e,t,1),t,n)}placeNodes({sliceDepth:e,frontierDepth:t,parent:n,inject:r,wrap:s}){for(;this.depth>t;)this.closeFrontierNode();if(s)for(let y=0;y<s.length;y++)this.openFrontierNode(s[y]);let l=this.unplaced,o=n?n.content:l.content,a=l.openStart-e,h=0,c=[],{match:p,type:f}=this.frontier[t];if(r){for(let y=0;y<r.childCount;y++)c.push(r.child(y));p=p.matchFragment(r)}let d=o.size+e-(l.content.size-l.openEnd);for(;h<o.childCount;){let y=o.child(h),v=p.matchType(y.type);if(!v)break;h++,(h>1||a==0||y.content.size)&&(p=v,c.push(Ke(y.mark(f.allowedMarks(y.marks)),h==1?a:0,h==o.childCount?d:-1)))}let g=h==o.childCount;g||(d=-1),this.placed=U(this.placed,t,m.from(c)),this.frontier[t].match=p,g&&d<0&&n&&n.type==this.frontier[this.depth].type&&this.frontier.length>1&&this.closeFrontierNode();for(let y=0,v=o;y<d;y++){let C=v.lastChild;this.frontier.push({type:C.type,match:C.contentMatchAt(C.childCount)}),v=C.content}this.unplaced=g?e==0?u.empty:new u(q(l.content,e-1,1),e-1,d<0?l.openEnd:e-1):new u(q(l.content,e,h),l.openStart,l.openEnd)}mustMoveInline(){if(!this.$to.parent.isTextblock)return-1;let e=this.frontier[this.depth],t;if(!e.type.isTextblock||!ue(this.$to,this.$to.depth,e.type,e.match,!1)||this.$to.depth==this.depth&&(t=this.findCloseLevel(this.$to))&&t.depth==this.depth)return-1;let{depth:n}=this.$to,r=this.$to.after(n);for(;n>1&&r==this.$to.end(--n);)++r;return r}findCloseLevel(e){e:for(let t=Math.min(this.depth,e.depth);t>=0;t--){let{match:n,type:r}=this.frontier[t],s=t<e.depth&&e.end(t+1)==e.pos+(e.depth-(t+1)),l=ue(e,t,r,n,s);if(l){for(let o=t-1;o>=0;o--){let{match:a,type:h}=this.frontier[o],c=ue(e,o,h,a,!0);if(!c||c.childCount)continue e}return{depth:t,fit:l,move:s?e.doc.resolve(e.after(t+1)):e}}}}close(e){let t=this.findCloseLevel(e);if(!t)return null;for(;this.depth>t.depth;)this.closeFrontierNode();t.fit.childCount&&(this.placed=U(this.placed,t.depth,t.fit)),e=t.move;for(let n=t.depth+1;n<=e.depth;n++){let r=e.node(n),s=r.type.contentMatch.fillBefore(r.content,!0,e.index(n));this.openFrontierNode(r.type,r.attrs,s)}return e}openFrontierNode(e,t=null,n){let r=this.frontier[this.depth];r.match=r.match.matchType(e),this.placed=U(this.placed,this.depth,m.from(e.create(t,n))),this.frontier.push({type:e,match:e.contentMatch})}closeFrontierNode(){let t=this.frontier.pop().match.fillBefore(m.empty,!0);t.childCount&&(this.placed=U(this.placed,this.frontier.length,t))}};function q(i,e,t){return e==0?i.cutByIndex(t,i.childCount):i.replaceChild(0,i.firstChild.copy(q(i.firstChild.content,e-1,t)))}function U(i,e,t){return e==0?i.append(t):i.replaceChild(i.childCount-1,i.lastChild.copy(U(i.lastChild.content,e-1,t)))}function fe(i,e){for(let t=0;t<e;t++)i=i.firstChild.content;return i}function Ke(i,e,t){if(e<=0)return i;let n=i.content;return e>1&&(n=n.replaceChild(0,Ke(n.firstChild,e-1,n.childCount==1?t-1:0))),e>0&&(n=i.type.contentMatch.fillBefore(n).append(n),t<=0&&(n=n.append(i.type.contentMatch.matchFragment(n).fillBefore(m.empty,!0)))),i.copy(n)}function ue(i,e,t,n,r){let s=i.node(e),l=r?i.indexAfter(e):i.index(e);if(l==s.childCount&&!t.compatibleContent(s.type))return null;let o=n.fillBefore(s.content,!0,l);return o&&!Bt(t,s.content,l)?o:null}function Bt(i,e,t){for(let n=t;n<e.childCount;n++)if(!i.allowsMarks(e.child(n).marks))return!0;return!1}function Wt(i){return i.spec.defining||i.spec.definingForContent}function Pt(i,e,t,n){if(!n.size)return i.deleteRange(e,t);let r=i.doc.resolve(e),s=i.doc.resolve(t);if(Ge(r,s,n))return i.step(new M(e,t,n));let l=Qe(r,i.doc.resolve(t));l[l.length-1]==0&&l.pop();let o=-(r.depth+1);l.unshift(o);for(let f=r.depth,d=r.pos-1;f>0;f--,d--){let g=r.node(f).type.spec;if(g.defining||g.definingAsContext||g.isolating)break;l.indexOf(f)>-1?o=f:r.before(f)==d&&l.splice(1,0,-f)}let a=l.indexOf(o),h=[],c=n.openStart;for(let f=n.content,d=0;;d++){let g=f.firstChild;if(h.push(g),d==n.openStart)break;f=g.content}for(let f=c-1;f>=0;f--){let d=h[f],g=Wt(d.type);if(g&&!d.sameMarkup(r.node(Math.abs(o)-1)))c=f;else if(g||!d.type.isTextblock)break}for(let f=n.openStart;f>=0;f--){let d=(f+c+1)%(n.openStart+1),g=h[d];if(g)for(let y=0;y<l.length;y++){let v=l[(y+a)%l.length],C=!0;v<0&&(C=!1,v=-v);let st=r.node(v-1),Me=r.index(v-1);if(st.canReplaceWith(Me,Me,g.type,g.marks))return i.replace(r.before(v),C?s.after(v):t,new u(He(n.content,0,n.openStart,d),d,n.openEnd))}}let p=i.steps.length;for(let f=l.length-1;f>=0&&(i.replace(e,t,n),!(i.steps.length>p));f--){let d=l[f];d<0||(e=r.before(d),t=s.after(d))}}function He(i,e,t,n,r){if(e<t){let s=i.firstChild;i=i.replaceChild(0,s.copy(He(s.content,e+1,t,n,s)))}if(e>n){let s=r.contentMatchAt(0),l=s.fillBefore(i).append(i);i=l.append(s.matchFragment(l).fillBefore(m.empty,!0))}return i}function Lt(i,e,t,n){if(!n.isInline&&e==t&&i.doc.resolve(e).parent.content.size){let r=Jt(i.doc,e,n.type);r!=null&&(e=t=r)}i.replaceRange(e,t,new u(m.from(n),0,0))}function qt(i,e,t){let n=i.doc.resolve(e),r=i.doc.resolve(t),s=Qe(n,r);for(let l=0;l<s.length;l++){let o=s[l],a=l==s.length-1;if(a&&o==0||n.node(o).type.contentMatch.validEnd)return i.delete(n.start(o),r.end(o));if(o>0&&(a||n.node(o-1).canReplace(n.index(o-1),r.indexAfter(o-1))))return i.delete(n.before(o),r.after(o))}for(let l=1;l<=n.depth&&l<=r.depth;l++)if(e-n.start(l)==n.depth-l&&t>n.end(l)&&r.end(l)-t!=r.depth-l&&n.start(l-1)==r.start(l-1)&&n.node(l-1).canReplace(n.index(l-1),r.index(l-1)))return i.delete(n.before(l),t);i.delete(e,t)}function Qe(i,e){let t=[],n=Math.min(i.depth,e.depth);for(let r=n;r>=0;r--){let s=i.start(r);if(s<i.pos-(i.depth-r)||e.end(r)>e.pos+(e.depth-r)||i.node(r).type.spec.isolating||e.node(r).type.spec.isolating)break;(s==e.start(r)||r==i.depth&&r==e.depth&&i.parent.inlineContent&&e.parent.inlineContent&&r&&e.start(r-1)==s-1)&&t.push(r)}return t}var _=class i extends x{constructor(e,t,n){super(),this.pos=e,this.attr=t,this.value=n}apply(e){let t=e.nodeAt(this.pos);if(!t)return k.fail("No node at attribute step's position");let n=Object.create(null);for(let s in t.attrs)n[s]=t.attrs[s];n[this.attr]=this.value;let r=t.type.create(n,null,t.marks);return k.fromReplace(e,this.pos,this.pos+1,new u(m.from(r),0,t.isLeaf?0:1))}getMap(){return b.empty}invert(e){return new i(this.pos,this.attr,e.nodeAt(this.pos).attrs[this.attr])}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new i(t.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.pos!="number"||typeof t.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new i(t.pos,t.attr,t.value)}};x.jsonID("attr",_);var ee=class i extends x{constructor(e,t){super(),this.attr=e,this.value=t}apply(e){let t=Object.create(null);for(let r in e.attrs)t[r]=e.attrs[r];t[this.attr]=this.value;let n=e.type.create(t,e.content,e.marks);return k.ok(n)}getMap(){return b.empty}invert(e){return new i(this.attr,e.attrs[this.attr])}map(e){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new i(t.attr,t.value)}};x.jsonID("docAttr",ee);var D=class extends Error{};D=function i(e){let t=Error.call(this,e);return t.__proto__=i.prototype,t};D.prototype=Object.create(Error.prototype);D.prototype.constructor=D;D.prototype.name="TransformError";var te=class{constructor(e){this.doc=e,this.steps=[],this.docs=[],this.mapping=new pe}get before(){return this.docs.length?this.docs[0]:this.doc}step(e){let t=this.maybeStep(e);if(t.failed)throw new D(t.failed);return this}maybeStep(e){let t=e.apply(this.doc);return t.failed||this.addStep(e,t.doc),t}get docChanged(){return this.steps.length>0}addStep(e,t){this.docs.push(this.doc),this.steps.push(e),this.mapping.appendMap(e.getMap()),this.doc=t}replace(e,t=e,n=u.empty){let r=Dt(this.doc,e,t,n);return r&&this.step(r),this}replaceWith(e,t,n){return this.replace(e,t,new u(m.from(n),0,0))}delete(e,t){return this.replace(e,t,u.empty)}insert(e,t){return this.replaceWith(e,e,t)}replaceRange(e,t,n){return Pt(this,e,t,n),this}replaceRangeWith(e,t,n){return Lt(this,e,t,n),this}deleteRange(e,t){return qt(this,e,t),this}lift(e,t){return Tt(this,e,t),this}join(e,t=1){return Ft(this,e,t),this}wrap(e,t){return Nt(this,e,t),this}setBlockType(e,t=e,n,r=null){return Rt(this,e,t,n,r),this}setNodeMarkup(e,t,n=null,r){return At(this,e,t,n,r),this}setNodeAttribute(e,t,n){return this.step(new _(e,t,n)),this}setDocAttribute(e,t){return this.step(new ee(e,t)),this}addNodeMark(e,t){return this.step(new K(e,t)),this}removeNodeMark(e,t){let n=this.doc.nodeAt(e);if(!n)throw new RangeError("No node at position "+e);if(t instanceof S)t.isInSet(n.marks)&&this.step(new J(e,t));else{let r=n.marks,s,l=[];for(;s=t.isInSet(r);)l.push(new J(e,s)),r=s.removeFromSet(r);for(let o=l.length-1;o>=0;o--)this.step(l[o])}return this}split(e,t=1,n){return zt(this,e,t,n),this}addMark(e,t,n){return Ot(this,e,t,n),this}removeMark(e,t,n){return Ct(this,e,t,n),this}clearIncompatible(e,t,n){return ye(this,e,t,n),this}};var we=Object.create(null),w=class{constructor(e,t,n){this.$anchor=e,this.$head=t,this.ranges=n||[new ke(e.min(t),e.max(t))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let e=this.ranges;for(let t=0;t<e.length;t++)if(e[t].$from.pos!=e[t].$to.pos)return!1;return!0}content(){return this.$from.doc.slice(this.from,this.to,!0)}replace(e,t=u.empty){let n=t.content.lastChild,r=null;for(let o=0;o<t.openEnd;o++)r=n,n=n.lastChild;let s=e.steps.length,l=this.ranges;for(let o=0;o<l.length;o++){let{$from:a,$to:h}=l[o],c=e.mapping.slice(s);e.replaceRange(c.map(a.pos),c.map(h.pos),o?u.empty:t),o==0&&Ze(e,s,(n?n.isInline:r&&r.isTextblock)?-1:1)}}replaceWith(e,t){let n=e.steps.length,r=this.ranges;for(let s=0;s<r.length;s++){let{$from:l,$to:o}=r[s],a=e.mapping.slice(n),h=a.map(l.pos),c=a.map(o.pos);s?e.deleteRange(h,c):(e.replaceRangeWith(h,c,t),Ze(e,n,t.isInline?-1:1))}}static findFrom(e,t,n=!1){let r=e.parent.inlineContent?new F(e):B(e.node(0),e.parent,e.pos,e.index(),t,n);if(r)return r;for(let s=e.depth-1;s>=0;s--){let l=t<0?B(e.node(0),e.node(s),e.before(s+1),e.index(s),t,n):B(e.node(0),e.node(s),e.after(s+1),e.index(s)+1,t,n);if(l)return l}return null}static near(e,t=1){return this.findFrom(e,t)||this.findFrom(e,-t)||new z(e.node(0))}static atStart(e){return B(e,e,0,0,1)||new z(e)}static atEnd(e){return B(e,e,e.content.size,e.childCount,-1)||new z(e)}static fromJSON(e,t){if(!t||!t.type)throw new RangeError("Invalid input for Selection.fromJSON");let n=we[t.type];if(!n)throw new RangeError(`No selection type ${t.type} defined`);return n.fromJSON(e,t)}static jsonID(e,t){if(e in we)throw new RangeError("Duplicate use of selection JSON ID "+e);return we[e]=t,t.prototype.jsonID=e,t}getBookmark(){return F.between(this.$anchor,this.$head).getBookmark()}};w.prototype.visible=!0;var ke=class{constructor(e,t){this.$from=e,this.$to=t}},Xe=!1;function Ye(i){!Xe&&!i.parent.inlineContent&&(Xe=!0,console.warn("TextSelection endpoint not pointing into a node with inline content ("+i.parent.type.name+")"))}var F=class i extends w{constructor(e,t=e){Ye(e),Ye(t),super(e,t)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(e,t){let n=e.resolve(t.map(this.head));if(!n.parent.inlineContent)return w.near(n);let r=e.resolve(t.map(this.anchor));return new i(r.parent.inlineContent?r:n,n)}replace(e,t=u.empty){if(super.replace(e,t),t==u.empty){let n=this.$from.marksAcross(this.$to);n&&e.ensureMarks(n)}}eq(e){return e instanceof i&&e.anchor==this.anchor&&e.head==this.head}getBookmark(){return new re(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(e,t){if(typeof t.anchor!="number"||typeof t.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new i(e.resolve(t.anchor),e.resolve(t.head))}static create(e,t,n=t){let r=e.resolve(t);return new this(r,n==t?r:e.resolve(n))}static between(e,t,n){let r=e.pos-t.pos;if((!n||r)&&(n=r>=0?1:-1),!t.parent.inlineContent){let s=w.findFrom(t,n,!0)||w.findFrom(t,-n,!0);if(s)t=s.$head;else return w.near(t,n)}return e.parent.inlineContent||(r==0?e=t:(e=(w.findFrom(e,-n,!0)||w.findFrom(e,n,!0)).$anchor,e.pos<t.pos!=r<0&&(e=t))),new i(e,t)}};w.jsonID("text",F);var re=class i{constructor(e,t){this.anchor=e,this.head=t}map(e){return new i(e.map(this.anchor),e.map(this.head))}resolve(e){return F.between(e.resolve(this.anchor),e.resolve(this.head))}},O=class i extends w{constructor(e){let t=e.nodeAfter,n=e.node(0).resolve(e.pos+t.nodeSize);super(e,n),this.node=t}map(e,t){let{deleted:n,pos:r}=t.mapResult(this.anchor),s=e.resolve(r);return n?w.near(s):new i(s)}content(){return new u(m.from(this.node),0,0)}eq(e){return e instanceof i&&e.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new Se(this.anchor)}static fromJSON(e,t){if(typeof t.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new i(e.resolve(t.anchor))}static create(e,t){return new i(e.resolve(t))}static isSelectable(e){return!e.isText&&e.type.spec.selectable!==!1}};O.prototype.visible=!1;w.jsonID("node",O);var Se=class i{constructor(e){this.anchor=e}map(e){let{deleted:t,pos:n}=e.mapResult(this.anchor);return t?new re(n,n):new i(n)}resolve(e){let t=e.resolve(this.anchor),n=t.nodeAfter;return n&&O.isSelectable(n)?new O(t):w.near(t)}},z=class i extends w{constructor(e){super(e.resolve(0),e.resolve(e.content.size))}replace(e,t=u.empty){if(t==u.empty){e.delete(0,e.doc.content.size);let n=w.atStart(e.doc);n.eq(e.selection)||e.setSelection(n)}else super.replace(e,t)}toJSON(){return{type:"all"}}static fromJSON(e){return new i(e)}map(e){return new i(e)}eq(e){return e instanceof i}getBookmark(){return Ut}};w.jsonID("all",z);var Ut={map(){return this},resolve(i){return new z(i)}};function B(i,e,t,n,r,s=!1){if(e.inlineContent)return F.create(i,t);for(let l=n-(r>0?0:1);r>0?l<e.childCount:l>=0;l+=r){let o=e.child(l);if(o.isAtom){if(!s&&O.isSelectable(o))return O.create(i,t-(r<0?o.nodeSize:0))}else{let a=B(i,o,t+r,r<0?o.childCount:0,r,s);if(a)return a}t+=o.nodeSize*r}return null}function Ze(i,e,t){let n=i.steps.length-1;if(n<e)return;let r=i.steps[n];if(!(r instanceof M||r instanceof E))return;let s=i.mapping.maps[n],l;s.forEach((o,a,h,c)=>{l==null&&(l=c)}),i.setSelection(w.near(i.doc.resolve(l),t))}var je=1,ne=2,$e=4,ve=class extends te{constructor(e){super(e.doc),this.curSelectionFor=0,this.updated=0,this.meta=Object.create(null),this.time=Date.now(),this.curSelection=e.selection,this.storedMarks=e.storedMarks}get selection(){return this.curSelectionFor<this.steps.length&&(this.curSelection=this.curSelection.map(this.doc,this.mapping.slice(this.curSelectionFor)),this.curSelectionFor=this.steps.length),this.curSelection}setSelection(e){if(e.$from.doc!=this.doc)throw new RangeError("Selection passed to setSelection must point at the current document");return this.curSelection=e,this.curSelectionFor=this.steps.length,this.updated=(this.updated|je)&~ne,this.storedMarks=null,this}get selectionSet(){return(this.updated&je)>0}setStoredMarks(e){return this.storedMarks=e,this.updated|=ne,this}ensureMarks(e){return S.sameSet(this.storedMarks||this.selection.$from.marks(),e)||this.setStoredMarks(e),this}addStoredMark(e){return this.ensureMarks(e.addToSet(this.storedMarks||this.selection.$head.marks()))}removeStoredMark(e){return this.ensureMarks(e.removeFromSet(this.storedMarks||this.selection.$head.marks()))}get storedMarksSet(){return(this.updated&ne)>0}addStep(e,t){super.addStep(e,t),this.updated=this.updated&~ne,this.storedMarks=null}setTime(e){return this.time=e,this}replaceSelection(e){return this.selection.replace(this,e),this}replaceSelectionWith(e,t=!0){let n=this.selection;return t&&(e=e.mark(this.storedMarks||(n.empty?n.$from.marks():n.$from.marksAcross(n.$to)||S.none))),n.replaceWith(this,e),this}deleteSelection(){return this.selection.replace(this),this}insertText(e,t,n){let r=this.doc.type.schema;if(t==null)return e?this.replaceSelectionWith(r.text(e),!0):this.deleteSelection();{if(n==null&&(n=t),n=n??t,!e)return this.deleteRange(t,n);let s=this.storedMarks;if(!s){let l=this.doc.resolve(t);s=n==t?l.marks():l.marksAcross(this.doc.resolve(n))}return this.replaceRangeWith(t,n,r.text(e,s)),this.selection.empty||this.setSelection(w.near(this.selection.$to)),this}}setMeta(e,t){return this.meta[typeof e=="string"?e:e.key]=t,this}getMeta(e){return this.meta[typeof e=="string"?e:e.key]}get isGeneric(){for(let e in this.meta)return!1;return!0}scrollIntoView(){return this.updated|=$e,this}get scrolledIntoView(){return(this.updated&$e)>0}};function _e(i,e){return!e||!i?i:i.bind(e)}var A=class{constructor(e,t,n){this.name=e,this.init=_e(t.init,n),this.apply=_e(t.apply,n)}},Vt=[new A("doc",{init(i){return i.doc||i.schema.topNodeType.createAndFill()},apply(i){return i.doc}}),new A("selection",{init(i,e){return i.selection||w.atStart(e.doc)},apply(i){return i.selection}}),new A("storedMarks",{init(i){return i.storedMarks||null},apply(i,e,t,n){return n.selection.$cursor?i.storedMarks:null}}),new A("scrollToSelection",{init(){return 0},apply(i,e){return i.scrolledIntoView?e+1:e}})],H=class{constructor(e,t){this.schema=e,this.plugins=[],this.pluginsByKey=Object.create(null),this.fields=Vt.slice(),t&&t.forEach(n=>{if(this.pluginsByKey[n.key])throw new RangeError("Adding different instances of a keyed plugin ("+n.key+")");this.plugins.push(n),this.pluginsByKey[n.key]=n,n.spec.state&&this.fields.push(new A(n.key,n.spec.state,n))})}},et=class i{constructor(e){this.config=e}get schema(){return this.config.schema}get plugins(){return this.config.plugins}apply(e){return this.applyTransaction(e).state}filterTransaction(e,t=-1){for(let n=0;n<this.config.plugins.length;n++)if(n!=t){let r=this.config.plugins[n];if(r.spec.filterTransaction&&!r.spec.filterTransaction.call(r,e,this))return!1}return!0}applyTransaction(e){if(!this.filterTransaction(e))return{state:this,transactions:[]};let t=[e],n=this.applyInner(e),r=null;for(;;){let s=!1;for(let l=0;l<this.config.plugins.length;l++){let o=this.config.plugins[l];if(o.spec.appendTransaction){let a=r?r[l].n:0,h=r?r[l].state:this,c=a<t.length&&o.spec.appendTransaction.call(o,a?t.slice(a):t,h,n);if(c&&n.filterTransaction(c,l)){if(c.setMeta("appendedTransaction",e),!r){r=[];for(let p=0;p<this.config.plugins.length;p++)r.push(p<l?{state:n,n:t.length}:{state:this,n:0})}t.push(c),n=n.applyInner(c),s=!0}r&&(r[l]={state:n,n:t.length})}}if(!s)return{state:n,transactions:t}}}applyInner(e){if(!e.before.eq(this.doc))throw new RangeError("Applying a mismatched transaction");let t=new i(this.config),n=this.config.fields;for(let r=0;r<n.length;r++){let s=n[r];t[s.name]=s.apply(e,this[s.name],this,t)}return t}get tr(){return new ve(this)}static create(e){let t=new H(e.doc?e.doc.type.schema:e.schema,e.plugins),n=new i(t);for(let r=0;r<t.fields.length;r++)n[t.fields[r].name]=t.fields[r].init(e,n);return n}reconfigure(e){let t=new H(this.schema,e.plugins),n=t.fields,r=new i(t);for(let s=0;s<n.length;s++){let l=n[s].name;r[l]=this.hasOwnProperty(l)?this[l]:n[s].init(e,r)}return r}toJSON(e){let t={doc:this.doc.toJSON(),selection:this.selection.toJSON()};if(this.storedMarks&&(t.storedMarks=this.storedMarks.map(n=>n.toJSON())),e&&typeof e=="object")for(let n in e){if(n=="doc"||n=="selection")throw new RangeError("The JSON fields `doc` and `selection` are reserved");let r=e[n],s=r.spec.state;s&&s.toJSON&&(t[n]=s.toJSON.call(r,this[r.key]))}return t}static fromJSON(e,t,n){if(!t)throw new RangeError("Invalid input for EditorState.fromJSON");if(!e.schema)throw new RangeError("Required config field 'schema' missing");let r=new H(e.schema,e.plugins),s=new i(r);return r.fields.forEach(l=>{if(l.name=="doc")s.doc=P.fromJSON(e.schema,t.doc);else if(l.name=="selection")s.selection=w.fromJSON(s.doc,t.selection);else if(l.name=="storedMarks")t.storedMarks&&(s.storedMarks=t.storedMarks.map(e.schema.markFromJSON));else{if(n)for(let o in n){let a=n[o],h=a.spec.state;if(a.key==l.name&&h&&h.fromJSON&&Object.prototype.hasOwnProperty.call(t,o)){s[l.name]=h.fromJSON.call(a,e,t[o],s);return}}s[l.name]=l.init(e,s)}}),s}};function rt(i,e,t){for(let n in i){let r=i[n];r instanceof Function?r=r.bind(e):n=="handleDOMEvents"&&(r=rt(r,e,{})),t[n]=r}return t}var tt=class{constructor(e){this.spec=e,this.props={},e.props&&rt(e.props,this,this.props),this.key=e.key?e.key.key:it("plugin")}getState(e){return e[this.key]}},xe=Object.create(null);function it(i){return i in xe?i+"$"+ ++xe[i]:(xe[i]=0,i+"$")}var nt=class{constructor(e="key"){this.key=it(e)}get(e){return e.config.pluginsByKey[this.key]}getState(e){return e[this.key]}};export{z as AllSelection,et as EditorState,O as NodeSelection,tt as Plugin,nt as PluginKey,w as Selection,ke as SelectionRange,F as TextSelection,ve as Transaction};
//# sourceMappingURL=prosemirror-state.bundle.mjs.map